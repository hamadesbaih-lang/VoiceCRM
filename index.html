<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1A1A2E">
  <title>VoiceCRM</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéôÔ∏è</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Sora:wght@700;800&display=swap" rel="stylesheet">
  <style>
    :root{--navy:#0F3460;--dark:#1A1A2E;--gold:#C8963E;--teal:#16697A;--green:#27AE60;--red:#D63031;--white:#FFF;--safe-top:env(safe-area-inset-top,20px);--safe-bottom:env(safe-area-inset-bottom,0px)}
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    html{height:100%;overflow:hidden;background:#1A1A2E}
    body{height:100%;overflow:hidden;font-family:'DM Sans',-apple-system,sans-serif;background:#1A1A2E;color:var(--white);margin:0}
    .app{position:fixed;inset:0;display:flex;flex-direction:column;background:linear-gradient(170deg,var(--dark),#0d1b3a 40%,var(--dark))}
    .app-header{flex-shrink:0;padding:8px 20px 6px;padding-top:calc(var(--safe-top) + 8px);display:flex;align-items:center;justify-content:space-between}
    .logo{font-family:'Sora',sans-serif;font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--gold),#e8b44f);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .logo-sub{font-size:9px;color:rgba(255,255,255,.25);letter-spacing:2px;text-transform:uppercase}
    .hdr-btns{display:flex;gap:8px}
    .icon-btn{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:7px 10px;color:rgba(255,255,255,.5);font-size:14px;cursor:pointer;line-height:1}
    .screens{flex:1;overflow:hidden;position:relative}
    .scr{position:absolute;inset:0;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:0 20px 20px;display:none;opacity:0;transition:opacity .2s}
    .scr.on{display:block;opacity:1}
    .bnav{flex-shrink:0;display:flex;align-items:flex-end;background:rgba(18,18,42,.95);backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,.06);padding:6px 8px;padding-bottom:calc(var(--safe-bottom) + 6px)}
    .bnav-i{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 0;cursor:pointer;border-radius:10px;transition:.2s}
    .bnav-i.on{background:rgba(200,150,62,.1)}
    .bnav-ic{font-size:20px;line-height:1}
    .bnav-lb{font-size:9px;font-weight:600;color:rgba(255,255,255,.3);letter-spacing:.5px}
    .bnav-i.on .bnav-lb{color:var(--gold)}
    .bnav-i.soon .bnav-ic,.bnav-i.soon .bnav-lb{opacity:.3}
    .bnav-center{position:relative;top:-18px;flex:1.2}
    .bnav-center .bnav-lb{margin-top:4px}
    .bnav-center.on{background:none}
    .bnav-mic{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--gold),#b8860b);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(200,150,62,.4);transition:transform .2s}
    .bnav-center.on .bnav-mic{box-shadow:0 4px 24px rgba(200,150,62,.6);transform:scale(1.05)}
    .bnav-mic-inner{font-size:26px;line-height:1}

    /* Setup */
    .su-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100%;padding:40px 0;text-align:center}
    .su-wrap h2{font-family:'Sora',sans-serif;font-size:20px;margin-bottom:8px;color:var(--gold)}
    .su-wrap p{font-size:13px;color:rgba(255,255,255,.4);margin-bottom:24px;line-height:1.6}
    .su-inp{width:100%;max-width:360px;padding:14px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.05);color:#fff;font-size:14px;outline:none;font-family:inherit;margin-bottom:12px}
    .su-inp::placeholder{color:rgba(255,255,255,.25)}
    .su-btn{width:100%;max-width:360px;padding:14px;border-radius:14px;border:none;background:linear-gradient(135deg,var(--gold),#b8860b);color:#fff;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit}
    .su-btn:disabled{opacity:.4}
    .su-note{font-size:11px;color:rgba(255,255,255,.2);margin-top:16px;line-height:1.5}

    /* Dashboard */
    .dg{font-size:18px;font-weight:700;margin:12px 0 4px;color:rgba(255,255,255,.9)}
    .dd{font-size:12px;color:rgba(255,255,255,.3);margin-bottom:16px}
    .kg{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px}
    .kc{background:rgba(255,255,255,.04);border-radius:16px;padding:14px 12px;border:1px solid rgba(255,255,255,.06);text-align:center;position:relative;overflow:hidden}
    .kc::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
    .kc.bl::before{background:var(--teal)}.kc.gr::before{background:var(--green)}.kc.go::before{background:var(--gold)}.kc.pu::before{background:#7B2D8E}.kc.ye::before{background:#F1C40F}.kc.re::before{background:var(--red)}
    .kn{font-size:28px;font-weight:800;font-family:'Sora',sans-serif;line-height:1}
    .kc.bl .kn{color:#5dc8d9}.kc.gr .kn{color:#5ddb8e}.kc.go .kn{color:var(--gold)}.kc.pu .kn{color:#b366cc}.kc.ye .kn{color:#F1C40F}.kc.re .kn{color:#e87878}
    .kl{font-size:10px;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:.5px;margin-top:4px;font-weight:600}
    .cb{background:rgba(255,255,255,.04);border-radius:14px;padding:12px 16px;margin-bottom:16px;border:1px solid rgba(255,255,255,.06)}
    .cb-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .cb-l{font-size:11px;color:rgba(255,255,255,.4);font-weight:600}
    .cb-p{font-size:18px;font-weight:800;color:var(--green);font-family:'Sora',sans-serif}
    .cb-t{height:6px;background:rgba(255,255,255,.08);border-radius:6px;overflow:hidden}
    .cb-f{height:100%;background:linear-gradient(90deg,var(--green),#2ecc71);border-radius:6px;transition:width .8s}
    .cb-s{font-size:10px;color:rgba(255,255,255,.25);margin-top:6px;text-align:right}
    .ds{margin-bottom:16px}
    .ds-h{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .ds-t{font-size:14px;font-weight:700;color:rgba(255,255,255,.8);display:flex;align-items:center;gap:6px}
    .cd{background:rgba(255,255,255,.04);border-radius:14px;border:1px solid rgba(255,255,255,.06);overflow:hidden}
    .pr{display:flex;align-items:center;padding:8px 14px;border-bottom:1px solid rgba(255,255,255,.04)}
    .pr:last-child{border-bottom:none}
    .pd{width:8px;height:8px;border-radius:50%;margin-right:10px;flex-shrink:0}
    .pn{flex:1;font-size:12px;color:rgba(255,255,255,.7)}
    .pc{font-size:14px;font-weight:700;color:rgba(255,255,255,.9);min-width:24px;text-align:right}
    .pb{width:50px;height:4px;background:rgba(255,255,255,.06);border-radius:4px;margin-left:10px}
    .pf{height:100%;border-radius:4px;transition:width .6s}
    .fi{display:flex;align-items:center;padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.04);gap:10px}
    .fi:last-child{border-bottom:none}
    .fp{width:6px;height:28px;border-radius:3px;flex-shrink:0}
    .fp.high{background:var(--red)}.fp.medium{background:var(--gold)}.fp.low{background:var(--teal)}
    .fb2{flex:1;min-width:0}
    .fc{font-size:13px;font-weight:600;color:rgba(255,255,255,.85);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .fd{font-size:11px;color:rgba(255,255,255,.4);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ft{font-size:10px;font-weight:700;padding:3px 8px;border-radius:8px;flex-shrink:0}
    .ft.overdue{background:rgba(214,48,49,.15);color:#e87878}
    .ft.today{background:rgba(200,150,62,.15);color:var(--gold)}
    .ft.upcoming{background:rgba(22,105,122,.12);color:#5dc8d9}
    .cg{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:12px}
    .ci{text-align:center}
    .cv{font-size:16px;font-weight:800;font-family:'Sora',sans-serif}
    .cl2{font-size:9px;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:.5px;margin-top:2px}
    .chl{display:flex;flex-wrap:wrap;gap:6px;padding:12px}
    .ch{padding:4px 10px;border-radius:10px;font-size:11px;font-weight:600;background:rgba(255,255,255,.06);color:rgba(255,255,255,.6);display:flex;align-items:center;gap:4px}
    .chc{background:rgba(255,255,255,.1);padding:1px 6px;border-radius:6px;font-size:10px;color:rgba(255,255,255,.8)}
    .dl{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 0;gap:16px}
    .sp{width:40px;height:40px;border-radius:50%;border:3px solid rgba(200,150,62,.15);border-top-color:var(--gold);animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Voice */
    .vw{display:flex;flex-direction:column;align-items:center;min-height:100%;justify-content:center;text-align:center;padding-bottom:20px}
    .st{font-size:18px;font-weight:600;color:rgba(255,255,255,.85);margin-bottom:6px}
    .ss{font-size:13px;color:rgba(255,255,255,.35)}
    .fb{margin:12px 0;padding:10px 16px;border-radius:12px;font-size:13px;text-align:center;line-height:1.5;width:100%;max-width:400px}
    .fb.info{background:rgba(22,105,122,.15);border:1px solid rgba(22,105,122,.3);color:#5dc8d9}
    .fb.ok{background:rgba(39,174,96,.15);border:1px solid rgba(39,174,96,.3);color:#5ddb8e}
    .fb.warn{background:rgba(200,150,62,.15);border:1px solid rgba(200,150,62,.3);color:#e8c56e}
    .fb.err{background:rgba(214,48,49,.15);border:1px solid rgba(214,48,49,.3);color:#e87878}
    .mw{display:flex;justify-content:center;margin:24px 0 8px}
    .mb{width:120px;height:120px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle,var(--gold),#b8860b);box-shadow:0 8px 32px rgba(200,150,62,.35);transition:.3s;outline:none;-webkit-appearance:none}
    .mb.rec{background:radial-gradient(circle,var(--red),#c0392b);animation:pr 1.5s ease-out infinite}
    .mb svg{width:48px;height:48px}
    @keyframes pr{0%{box-shadow:0 0 0 0 rgba(214,48,49,.5)}50%{box-shadow:0 0 0 20px rgba(214,48,49,0)}100%{box-shadow:0 0 0 0 rgba(214,48,49,0)}}
    .tm{font-size:28px;font-weight:700;color:var(--red);margin:12px 0;font-variant-numeric:tabular-nums}
    .wf{display:flex;align-items:center;justify-content:center;gap:3px;height:40px;margin:12px 0}
    .wb{width:3px;border-radius:2px;height:4px;background:linear-gradient(to top,var(--gold),var(--teal));opacity:.15}
    .wf.on .wb{opacity:.8;animation:wv .8s ease-in-out infinite alternate}
    @keyframes wv{from{height:4px}to{height:32px}}
    .tb{background:rgba(255,255,255,.06);border-radius:16px;padding:16px 20px;margin:12px 0;border:1px solid rgba(200,150,62,.15);max-height:120px;overflow:auto;text-align:left;width:100%}
    .tl{font-size:11px;color:var(--gold);font-weight:600;letter-spacing:1.5px;margin-bottom:8px;text-transform:uppercase}
    .tt{font-size:15px;line-height:1.6;color:rgba(255,255,255,.9)}
    .tir{display:flex;gap:8px;width:100%;max-width:400px;margin:12px 0}
    .ti{flex:1;padding:12px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:#fff;font-size:14px;outline:none;font-family:inherit}
    .ti::placeholder{color:rgba(255,255,255,.25)}
    .bs{padding:12px 20px;border-radius:14px;border:none;background:var(--gold);color:#fff;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit}
    .hr{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:16px}
    .hc{padding:8px 14px;border-radius:20px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;font-family:inherit;text-align:left}
    .rc{background:rgba(255,255,255,.05);border-radius:20px;overflow:hidden;text-align:left;width:100%;max-width:440px;animation:su .4s ease-out}
    .rh{padding:14px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,.06)}
    .ri{display:flex;align-items:center;gap:10px}
    .rl{font-size:14px;font-weight:700;letter-spacing:.5px}
    .rt2{font-size:11px;color:rgba(255,255,255,.4)}
    .cbg{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700}
    .rb{padding:14px 18px}
    .rcl{font-size:13px;color:rgba(255,255,255,.85);line-height:1.6;margin-bottom:14px;font-style:italic}
    .dg2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .df{background:rgba(255,255,255,.04);border-radius:10px;padding:8px 12px;border:1px solid rgba(255,255,255,.06)}
    .dk{font-size:10px;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:1px;margin-bottom:2px}
    .dv{font-size:13px;color:rgba(255,255,255,.9);font-weight:500;word-break:break-word}
    .fub{margin-top:12px;background:rgba(123,45,142,.12);border-radius:12px;padding:10px 14px;border:1px solid rgba(123,45,142,.2);display:flex;align-items:center;gap:10px}
    .ful{font-size:11px;color:rgba(255,255,255,.5);margin-bottom:2px}
    .fut{font-size:13px;color:rgba(255,255,255,.85)}
    .fud{color:var(--gold);font-weight:600;margin-left:6px}
    .act{padding:12px 18px 16px;display:flex;gap:10px}
    .bcf{flex:1;padding:12px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--green),#219a52);color:#fff;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit}
    .bsc{padding:12px 18px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:transparent;color:rgba(255,255,255,.6);font-size:14px;font-weight:600;cursor:pointer;font-family:inherit}

    /* Coming soon */
    .cs{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100%;gap:12px;text-align:center;padding:40px 0}
    .cs-i{font-size:48px;opacity:.4}
    .cs-t{font-size:18px;font-weight:700;color:rgba(255,255,255,.5)}
    .cs-d{font-size:13px;color:rgba(255,255,255,.25)}

    /* Modal */
    .mbg{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);display:none;align-items:flex-end;justify-content:center;z-index:100}
    .mbg.show{display:flex}
    .mc{background:var(--dark);border-radius:24px 24px 0 0;width:100%;max-width:480px;max-height:80vh;overflow:auto;padding:24px;padding-bottom:calc(24px + var(--safe-bottom))}
    .mt{font-size:16px;font-weight:700;margin-bottom:20px}
    .mf{margin-bottom:12px}
    .mlb{font-size:11px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;display:block}
    .mi{width:100%;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:#fff;font-size:14px;outline:none;font-family:inherit}
    .ma{display:flex;gap:10px;margin-top:20px}
    @keyframes su{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
    ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:4px}
    .hidden{display:none!important}
  </style>
</head>
<body>
<div id="setupScreen" class="app">
  <div class="screens"><div class="scr on"><div class="su-wrap">
    <div style="font-size:48px;margin-bottom:16px">üéôÔ∏è</div>
    <h2>Welcome to VoiceCRM</h2>
    <p>Paste your Google Apps Script Web App URL to connect.</p>
    <input type="text" class="su-inp" id="apiUrlInput" placeholder="https://script.google.com/macros/s/xxxxx/exec">
    <button class="su-btn" id="setupBtn" onclick="saveApiUrl()">Connect</button>
    <div class="su-note">Saved locally on this device. One-time setup.</div>
  </div></div></div>
</div>

<div id="mainApp" class="app hidden">
  <div class="app-header">
    <div><div class="logo">VoiceCRM</div><div class="logo-sub">by SheetSouq</div></div>
    <div class="hdr-btns"><button class="icon-btn" onclick="loadDash()">üîÑ</button><button class="icon-btn" onclick="showSetup()">‚öôÔ∏è</button></div>
  </div>
  <div class="screens">
    <div id="sDash" class="scr on">
      <div class="dl" id="dashLoad"><div class="sp"></div><div style="font-size:13px;color:rgba(255,255,255,.3)">Loading dashboard...</div></div>
      <div id="dashC" class="hidden"></div>
    </div>
    <div id="sVoice" class="scr">
      <div class="vw" id="vWrap">
        <div id="vIdle">
          <div class="st" id="stT">Tap to speak</div>
          <div class="ss" id="stS">Tell me about a lead, viewing, deal, or follow-up</div>
          <div class="mw" id="mWrap"><button class="mb" id="mBtn" onclick="toggleMic()"><svg viewBox="0 0 24 24" fill="none" id="mIco"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" fill="white"/><path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke="white" stroke-width="2" stroke-linecap="round"/><line x1="12" y1="19" x2="12" y2="23" stroke="white" stroke-width="2" stroke-linecap="round"/><line x1="8" y1="23" x2="16" y2="23" stroke="white" stroke-width="2" stroke-linecap="round"/></svg></button></div>
          <div class="tm hidden" id="tmr">0:00</div>
          <div class="wf" id="wfm"></div>
          <div id="fbBox"></div>
          <div class="tb hidden" id="tBox"><div class="tl">Transcription</div><div class="tt" id="tText"></div></div>
          <div class="sp hidden" id="vSpin"></div>
          <div style="font-size:11px;color:rgba(255,255,255,.2);margin-top:16px">or type your update</div>
          <div class="tir"><input type="text" class="ti" id="tInp" placeholder="Type your update here..." onkeydown="if(event.key==='Enter')subText()"><button class="bs" onclick="subText()">Send</button></div>
          <div class="hr">
            <button class="hc" onclick="useH(this)">New lead from Bayut, Mohammed, 2-bed in JLT, budget 1.2 million</button>
            <button class="hc" onclick="useH(this)">Just showed the Marina apartment to Sarah, she loved it</button>
            <button class="hc" onclick="useH(this)">Remind me to call Ahmed on Thursday about the offer</button>
          </div>
        </div>
        <div id="vRes" class="hidden" style="width:100%"></div>
      </div>
    </div>
    <div id="sLeads" class="scr"><div class="cs"><div class="cs-i">üë§</div><div class="cs-t">Leads</div><div class="cs-d">Browse, search & manage leads.<br>Coming soon.</div></div></div>
    <div id="sTasks" class="scr"><div class="cs"><div class="cs-i">üìÖ</div><div class="cs-t">Follow-Ups</div><div class="cs-d">View, complete & track tasks.<br>Coming soon.</div></div></div>
    <div id="sDeals" class="scr"><div class="cs"><div class="cs-i">ü§ù</div><div class="cs-t">Deals</div><div class="cs-d">Pipeline, commissions & tracker.<br>Coming soon.</div></div></div>
  </div>
  <div class="bnav">
    <div class="bnav-i on" data-t="Dash" onclick="sTab('Dash')"><div class="bnav-ic">üìä</div><div class="bnav-lb">Dashboard</div></div>
    <div class="bnav-i soon" data-t="Leads" onclick="sTab('Leads')"><div class="bnav-ic">üë§</div><div class="bnav-lb">Leads</div></div>
    <div class="bnav-i bnav-center" data-t="Voice" onclick="sTab('Voice')"><div class="bnav-mic"><div class="bnav-mic-inner">üéôÔ∏è</div></div><div class="bnav-lb">Voice</div></div>
    <div class="bnav-i soon" data-t="Tasks" onclick="sTab('Tasks')"><div class="bnav-ic">üìÖ</div><div class="bnav-lb">Tasks</div></div>
    <div class="bnav-i soon" data-t="Deals" onclick="sTab('Deals')"><div class="bnav-ic">ü§ù</div><div class="bnav-lb">Deals</div></div>
  </div>
</div>

<div class="mbg" id="eModal" onclick="if(event.target===this)this.classList.remove('show')">
  <div class="mc"><div class="mt">Edit Data</div><div id="eFlds"></div>
    <div class="ma"><button class="bcf" onclick="saveEd()">Save</button><button class="bsc" onclick="document.getElementById('eModal').classList.remove('show')">Cancel</button></div>
  </div>
</div>

<script>
var API='',dash=null,aiRes=null,isRec=false,mRec=null,aChunks=[],recStart=0,tmInt=null,pStream=null,rMime='';
var INT={new_lead:{l:'New Lead',i:'üë§',c:'#16697A',t:'Leads'},viewing_update:{l:'Viewing',i:'üè†',c:'#C8963E',t:'Viewings'},follow_up:{l:'Follow-Up',i:'üìÖ',c:'#7B2D8E',t:'FollowUps'},deal_update:{l:'Deal',i:'ü§ù',c:'#27AE60',t:'Deals'},commission_log:{l:'Commission',i:'üí∞',c:'#C8963E',t:'Commissions'},property_note:{l:'Property',i:'üèóÔ∏è',c:'#0F3460',t:'Properties'},general_note:{l:'Note',i:'üìù',c:'#1A1A2E',t:'VoiceLog'}};
var PC={'New':'#5dc8d9','Contacted':'#4fb3bf','Qualified':'#C8963E','Viewing Scheduled':'#b366cc','Viewing Done':'#7B2D8E','Offer Made':'#F1C40F','Negotiating':'#e67e22','Closed Won':'#27AE60','Closed Lost':'#D63031','On Hold':'#95a5a6'};

function api(p){return fetch(API,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(p),redirect:'follow'}).then(function(r){if(!r.ok)throw new Error('Error:'+r.status);return r.json()});}
function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function fA(n){return n?Math.round(n).toLocaleString():'0';}
function sO(o){return Object.entries(o).sort(function(a,b){return b[1]-a[1]});}

// Setup
function chkSetup(){API=localStorage.getItem('voicecrm_api_url')||'';if(API){$('setupScreen').classList.add('hidden');$('mainApp').classList.remove('hidden');initApp();}else{$('setupScreen').classList.remove('hidden');$('mainApp').classList.add('hidden');}}
function saveApiUrl(){var u=$('apiUrlInput').value.trim();if(!u||!u.startsWith('https://script.google.com/')){alert('Enter a valid Apps Script URL.');return;}var b=$('setupBtn');b.textContent='Connecting...';b.disabled=true;fetch(u,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'ping'}),redirect:'follow'}).then(function(r){return r.json()}).then(function(d){if(d.success){localStorage.setItem('voicecrm_api_url',u);API=u;$('setupScreen').classList.add('hidden');$('mainApp').classList.remove('hidden');initApp();}else throw new Error(d.error||'Failed');}).catch(function(e){alert('Error: '+e.message);b.textContent='Connect';b.disabled=false;});}
function showSetup(){$('apiUrlInput').value=API;$('setupScreen').classList.remove('hidden');$('mainApp').classList.add('hidden');$('setupBtn').textContent='Connect';$('setupBtn').disabled=false;}
function $(id){return document.getElementById(id);}

// Init
function initApp(){var w=$('wfm');if(!w.children.length)for(var i=0;i<24;i++){var b=document.createElement('div');b.className='wb';b.style.animationDelay=i*.04+'s';w.appendChild(b);}if(navigator.mediaDevices)navigator.mediaDevices.getUserMedia({audio:true}).then(function(s){pStream=s;}).catch(function(){});loadDash();}

// Nav
function sTab(t){['Dash','Voice','Leads','Tasks','Deals'].forEach(function(s){var el=$('s'+s);if(el)el.classList.toggle('on',s===t);});document.querySelectorAll('.bnav-i').forEach(function(n){n.classList.toggle('on',n.dataset.t===t);});}

// Dashboard
function loadDash(){$('dashLoad').classList.remove('hidden');$('dashLoad').innerHTML='<div class="sp"></div><div style="font-size:13px;color:rgba(255,255,255,.3)">Loading dashboard...</div>';$('dashC').classList.add('hidden');api({action:'getDashboard'}).then(function(d){if(d.success){dash=d;renderDash(d);}else $('dashLoad').innerHTML='<div style="padding:40px;text-align:center;color:rgba(255,255,255,.3)">‚ùå '+esc(d.error)+'</div>';}).catch(function(e){$('dashLoad').innerHTML='<div style="padding:40px;text-align:center;color:rgba(255,255,255,.3)">‚ùå Connection error</div>';});}

function renderDash(d){
  var k=d.kpis,days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],mons=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],now=new Date(),ds=days[now.getDay()]+', '+now.getDate()+' '+mons[now.getMonth()],gr=now.getHours()<12?'Good Morning':'Good Afternoon',h='';
  h+='<div class="dg">'+gr+(d.agentName?', '+esc(d.agentName):'')+'</div><div class="dd">'+ds+'</div>';
  h+='<div class="kg"><div class="kc bl"><div class="kn">'+k.totalLeads+'</div><div class="kl">Total Leads</div></div><div class="kc gr"><div class="kn">'+k.activeLeads+'</div><div class="kl">Active</div></div><div class="kc go"><div class="kn">'+k.dealsWon+'</div><div class="kl">Won</div></div><div class="kc pu"><div class="kn">'+k.totalViewings+'</div><div class="kl">Viewings</div></div><div class="kc ye"><div class="kn">'+k.pendingFollowUps+'</div><div class="kl">Pending</div></div><div class="kc re"><div class="kn">'+k.overdueFollowUps+'</div><div class="kl">Overdue</div></div></div>';
  var pct=Math.round(d.conversionRate*100);
  h+='<div class="cb"><div class="cb-h"><div class="cb-l">Conversion Rate</div><div class="cb-p">'+pct+'%</div></div><div class="cb-t"><div class="cb-f" style="width:'+Math.min(pct,100)+'%"></div></div><div class="cb-s">Won '+k.dealsWon+' of '+k.totalLeads+' leads</div></div>';
  if(d.overdueFollowUps&&d.overdueFollowUps.length){h+='<div class="ds"><div class="ds-h"><div class="ds-t">üö® Overdue</div></div><div class="cd">';d.overdueFollowUps.forEach(function(f){h+=fuR(f,'overdue');});h+='</div></div>';}
  if(d.todayFollowUps&&d.todayFollowUps.length){h+='<div class="ds"><div class="ds-h"><div class="ds-t">üìå Today\'s Tasks</div></div><div class="cd">';d.todayFollowUps.forEach(function(f){h+=fuR(f,'today');});h+='</div></div>';}
  var pks=['New','Contacted','Qualified','Viewing Scheduled','Viewing Done','Offer Made','Negotiating','Closed Won','Closed Lost','On Hold'],mx=0;pks.forEach(function(p){var v=d.pipeline[p]||0;if(v>mx)mx=v;});
  if(mx){h+='<div class="ds"><div class="ds-h"><div class="ds-t">üìà Pipeline</div></div><div class="cd">';pks.forEach(function(p){var v=d.pipeline[p]||0;if(!v)return;var c=PC[p]||'#999',w=Math.round(v/mx*100);h+='<div class="pr"><div class="pd" style="background:'+c+'"></div><div class="pn">'+esc(p)+'</div><div class="pc">'+v+'</div><div class="pb"><div class="pf" style="width:'+w+'%;background:'+c+'"></div></div></div>';});h+='</div></div>';}
  if(d.commissions&&d.commissions.total){h+='<div class="ds"><div class="ds-h"><div class="ds-t">üí∞ Commissions</div></div><div class="cd"><div class="cg"><div class="ci"><div class="cv" style="color:var(--gold)">'+fA(d.commissions.total)+'</div><div class="cl2">Total</div></div><div class="ci"><div class="cv" style="color:var(--green)">'+fA(d.commissions.myNet)+'</div><div class="cl2">My Net</div></div><div class="ci"><div class="cv" style="color:#5ddb8e">'+fA(d.commissions.paid)+'</div><div class="cl2">Paid</div></div><div class="ci"><div class="cv" style="color:#e8c56e">'+fA(d.commissions.expected)+'</div><div class="cl2">Expected</div></div></div></div></div>';}
  if(Object.keys(d.sources).length){h+='<div class="ds"><div class="ds-h"><div class="ds-t">üì° Lead Sources</div></div><div class="cd"><div class="chl">';sO(d.sources).forEach(function(s){h+='<div class="ch">'+esc(s[0])+'<span class="chc">'+s[1]+'</span></div>';});h+='</div></div></div>';}
  if(Object.keys(d.areas).length){h+='<div class="ds"><div class="ds-h"><div class="ds-t">üìç Top Areas</div></div><div class="cd"><div class="chl">';sO(d.areas).slice(0,8).forEach(function(a){h+='<div class="ch">'+esc(a[0])+'<span class="chc">'+a[1]+'</span></div>';});h+='</div></div></div>';}
  if(d.upcomingFollowUps&&d.upcomingFollowUps.length){h+='<div class="ds"><div class="ds-h"><div class="ds-t">üìÖ Upcoming</div></div><div class="cd">';d.upcomingFollowUps.slice(0,5).forEach(function(f){h+=fuR(f,'upcoming');});h+='</div></div>';}
  if(d.recentLeads&&d.recentLeads.length){h+='<div class="ds"><div class="ds-h"><div class="ds-t">üÜï Recent Leads</div></div><div class="cd">';d.recentLeads.slice(0,5).forEach(function(l){var sc=PC[l.status]||'#999';h+='<div class="fi"><div class="fp" style="background:'+sc+'"></div><div class="fb2"><div class="fc">'+esc(l.name||l.id)+'</div><div class="fd">'+esc(l.area||'')+' ‚Ä¢ '+esc(l.source||'')+'</div></div><div class="ft upcoming">'+esc(l.status||'New')+'</div></div>';});h+='</div></div>';}
  h+='<div style="text-align:center;padding:20px 0;font-size:10px;color:rgba(255,255,255,.12)">VoiceCRM by SheetSouq ‚Ä¢ EN / AR / RU</div>';
  $('dashC').innerHTML=h;$('dashLoad').classList.add('hidden');$('dashC').classList.remove('hidden');
}
function fuR(f,t){var p=f.priority?f.priority.toLowerCase():'medium',dl=t==='today'?'Today':f.dueDate;return '<div class="fi"><div class="fp '+p+'"></div><div class="fb2"><div class="fc">'+esc(f.client)+'</div><div class="fd">'+esc(f.action+(f.details?' ‚Äî '+f.details:''))+'</div></div><div class="ft '+t+'">'+esc(dl)+'</div></div>';}

// Voice
function showFB(m,t){$('fbBox').innerHTML='<div class="fb '+(t||'info')+'">'+m+'</div>';}
function hideFB(){$('fbBox').innerHTML='';}
function stTm(){recStart=Date.now();$('tmr').classList.remove('hidden');tmInt=setInterval(function(){var s=Math.floor((Date.now()-recStart)/1000);$('tmr').textContent=Math.floor(s/60)+':'+(s%60<10?'0':'')+(s%60);},200);}
function spTm(){clearInterval(tmInt);$('tmr').classList.add('hidden');}
function toggleMic(){if(isRec)stopRec();else startRec();}

function startRec(){
  aiRes=null;aChunks=[];isRec=true;uMic(true);$('vRes').classList.add('hidden');$('vIdle').style.display='';$('tBox').classList.add('hidden');$('wfm').classList.add('on');$('stT').textContent='Starting mic...';$('stT').style.color='var(--gold)';$('stS').textContent='';
  if(pStream&&pStream.active){beginRec(pStream);return;}
  navigator.mediaDevices.getUserMedia({audio:true}).then(function(s){pStream=s;beginRec(s);}).catch(function(e){isRec=false;uMic(false);showFB(e.name==='NotAllowedError'?'‚ùå Mic blocked. Tap üîí ‚Üí Allow.':'‚ùå '+e.message,'err');$('stT').textContent='Mic unavailable';$('stT').style.color='var(--red)';});
}
function beginRec(s){
  var o={};if(MediaRecorder.isTypeSupported('audio/webm;codecs=opus'))o.mimeType='audio/webm;codecs=opus';else if(MediaRecorder.isTypeSupported('audio/webm'))o.mimeType='audio/webm';else if(MediaRecorder.isTypeSupported('audio/mp4'))o.mimeType='audio/mp4';rMime=o.mimeType||'audio/webm';
  mRec=new MediaRecorder(s,o);mRec.ondataavailable=function(e){if(e.data&&e.data.size>0)aChunks.push(e.data);};
  mRec.onstop=function(){spTm();if(!aChunks.length){showFB('No audio.','warn');vIdle();return;}var blob=new Blob(aChunks,{type:rMime}),sec=Math.floor((Date.now()-recStart)/1000);if(sec<1){showFB('Too short.','warn');vIdle();return;}showFB('üéµ '+sec+'s. Processing...','ok');$('mWrap').classList.add('hidden');$('wfm').classList.add('hidden');$('vSpin').classList.remove('hidden');$('stT').textContent='‚öôÔ∏è Transcribing...';$('stS').textContent='Whisper ‚Üí Claude AI';var r=new FileReader();r.onloadend=function(){sendAud(r.result.split(',')[1]);};r.readAsDataURL(blob);};
  mRec.onerror=function(){showFB('Rec error','err');isRec=false;uMic(false);spTm();};
  mRec.start(250);stTm();$('stT').textContent='üî¥ Recording...';$('stT').style.color='var(--red)';$('stS').textContent='Speak naturally. Tap ‚ñ† when done.';showFB('üéôÔ∏è <strong>Recording!</strong> Tap red button when done.','ok');
}
function stopRec(){isRec=false;uMic(false);$('wfm').classList.remove('on');if(mRec&&mRec.state!=='inactive')mRec.stop();else{spTm();vIdle();}}
function sendAud(b){api({action:'processAudio',audio:b}).then(function(r){if(r.success&&r.aiResult){aiRes=r.aiResult;if(r.transcript){$('tBox').classList.remove('hidden');$('tText').textContent=r.transcript;}vResult();showFB('‚úì Processed!','ok');}else{showFB('Error: '+(r.error||''),'err');vErr(r.error);}}).catch(function(e){showFB('‚ùå '+e.message,'err');vErr('Connection failed.');});}
function procTxt(t){$('mWrap').classList.add('hidden');$('wfm').classList.add('hidden');$('vSpin').classList.remove('hidden');$('stT').textContent='‚öôÔ∏è AI thinking...';$('stT').style.color='var(--gold)';$('tBox').classList.remove('hidden');$('tText').textContent=t;showFB('Sending...','info');api({action:'processText',text:t}).then(function(r){if(r.success&&r.aiResult){aiRes=r.aiResult;vResult();showFB('‚úì Processed!','ok');}else{showFB('Error: '+(r.error||''),'err');vErr(r.error);}}).catch(function(e){showFB('‚ùå '+e.message,'err');vErr('Connection failed.');});}
function confirmRes(){if(!aiRes)return;var b=document.querySelector('.bcf');b.textContent='‚è≥ Saving...';b.disabled=true;api({action:'confirmWrite',aiResult:aiRes}).then(function(r){if(r.success){vSaved();showFB('‚úì Saved!','ok');}else{showFB('Error: '+(r.error||''),'err');b.textContent='‚úì Confirm & Save';b.disabled=false;}}).catch(function(e){showFB('‚ùå '+e.message,'err');b.textContent='‚úì Confirm & Save';b.disabled=false;});}

function vIdle(){$('vIdle').style.display='';$('vRes').classList.add('hidden');$('stT').textContent='Tap to speak';$('stT').style.color='';$('stS').textContent='Tell me about a lead, viewing, deal, or follow-up';$('mWrap').classList.remove('hidden');$('wfm').classList.remove('hidden');$('wfm').classList.remove('on');$('vSpin').classList.add('hidden');$('tBox').classList.add('hidden');uMic(false);}
function vErr(m){$('vIdle').style.display='';$('stT').textContent=m||'Error';$('stT').style.color='var(--red)';$('stS').textContent='Tap mic to retry';$('mWrap').classList.remove('hidden');$('vSpin').classList.add('hidden');uMic(false);}
function vResult(){$('vIdle').style.display='none';$('vRes').classList.remove('hidden');$('vSpin').classList.add('hidden');rndRes();}
function vSaved(){$('vRes').classList.add('hidden');$('vIdle').style.display='';$('stT').innerHTML='<div style="font-size:48px;margin-bottom:8px">‚úÖ</div>Saved!';$('stT').style.color='var(--green)';$('stS').textContent='';$('mWrap').classList.add('hidden');$('tBox').classList.add('hidden');setTimeout(function(){aiRes=null;hideFB();vIdle();loadDash();},2500);}
function uMic(r){var b=$('mBtn'),ic=$('mIco');if(r){b.classList.add('rec');ic.innerHTML='<rect x="6" y="6" width="12" height="12" rx="2" fill="white"/>';}else{b.classList.remove('rec');ic.innerHTML='<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" fill="white"/><path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke="white" stroke-width="2" stroke-linecap="round"/><line x1="12" y1="19" x2="12" y2="23" stroke="white" stroke-width="2" stroke-linecap="round"/><line x1="8" y1="23" x2="16" y2="23" stroke="white" stroke-width="2" stroke-linecap="round"/>';}}

function rndRes(){
  var r=aiRes;if(!r)return;var it=INT[r.intent]||INT.general_note,cf=Math.round((r.confidence||0)*100),cc=cf>=85?'var(--green)':cf>=70?'var(--gold)':'var(--red)',h='';
  h+='<div class="rc" style="border:1px solid '+it.c+'33"><div class="rh" style="background:linear-gradient(135deg,'+it.c+'15,'+it.c+'05)"><div class="ri"><span style="font-size:24px">'+it.i+'</span><div><div class="rl" style="color:'+it.c+'">'+it.l+'</div><div class="rt2">‚Üí '+it.t+'</div></div></div><div class="cbg" style="background:'+cc+'22;color:'+cc+'">'+cf+'%</div></div>';
  h+='<div class="rb"><div class="rcl">"'+esc(r.clean_text||'')+'"</div>';
  if(r.data){h+='<div class="dg2">';Object.keys(r.data).forEach(function(k){var v=r.data[k];if(!v&&v!==0)return;var lb=k.replace(/_/g,' ').replace(/\b\w/g,function(c){return c.toUpperCase();}),dv=typeof v==='number'&&v>1000?'AED '+v.toLocaleString():String(v);h+='<div class="df"><div class="dk">'+esc(lb)+'</div><div class="dv">'+esc(dv)+'</div></div>';});h+='</div>';}
  if(r.follow_up_suggestion){h+='<div class="fub"><span style="font-size:16px">üìÖ</span><div><div class="ful">Auto Follow-Up</div><div class="fut">'+esc(r.follow_up_suggestion.action)+'<span class="fud"> in '+r.follow_up_suggestion.due_days+'d</span></div></div></div>';}
  h+='</div><div class="act"><button class="bcf" onclick="confirmRes()">‚úì Confirm & Save</button><button class="bsc" onclick="openEd()">Edit</button><button class="bsc" onclick="hideFB();vIdle()">Retry</button></div></div>';
  $('vRes').innerHTML=h;
}
function openEd(){if(!aiRes||!aiRes.data)return;var h='';Object.keys(aiRes.data).forEach(function(k){var v=aiRes.data[k];if(v===null||v===undefined)v='';h+='<div class="mf"><label class="mlb">'+esc(k.replace(/_/g,' '))+'</label><input class="mi" data-key="'+k+'" value="'+esc(String(v))+'"></div>';});$('eFlds').innerHTML=h;$('eModal').classList.add('show');}
function saveEd(){document.querySelectorAll('#eFlds .mi').forEach(function(i){var k=i.dataset.key,v=i.value;if(!isNaN(v)&&v.trim())v=Number(v);aiRes.data[k]=v;});$('eModal').classList.remove('show');rndRes();}
function subText(){var i=$('tInp'),t=i.value.trim();if(t.length>2){i.value='';procTxt(t);}}
function useH(e){procTxt(e.textContent);}

window.onload=function(){chkSetup();};
</script>
</body>
</html>
