<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>VoiceCRM</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ™ï¸</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Sora:wght@700;800&display=swap" rel="stylesheet">
  <style>
    :root { --navy:#0F3460; --dark:#1A1A2E; --gold:#C8963E; --teal:#16697A; --green:#27AE60; --red:#D63031; --white:#FFFFFF; }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    body{font-family:'DM Sans',-apple-system,sans-serif;background:linear-gradient(170deg,var(--dark) 0%,#0d1b3a 40%,var(--dark) 100%);color:var(--white);min-height:100vh;overflow-x:hidden}
    .container{max-width:480px;margin:0 auto;padding:0 20px;position:relative;z-index:1}
    .blob1,.blob2{position:fixed;border-radius:50%;pointer-events:none;z-index:0}
    .blob1{top:-120px;right:-120px;width:350px;height:350px;background:radial-gradient(circle,rgba(200,150,62,0.04),transparent 70%)}
    .blob2{bottom:-80px;left:-80px;width:280px;height:280px;background:radial-gradient(circle,rgba(22,105,122,0.03),transparent 70%)}

    /* Setup screen */
    .setup-screen{padding:40px 0;text-align:center}
    .setup-screen h2{font-family:'Sora',sans-serif;font-size:20px;margin-bottom:8px;color:var(--gold)}
    .setup-screen p{font-size:13px;color:rgba(255,255,255,0.4);margin-bottom:24px;line-height:1.6}
    .setup-input{width:100%;padding:14px 16px;border-radius:14px;border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.05);color:white;font-size:14px;outline:none;font-family:'DM Sans',sans-serif;margin-bottom:12px}
    .setup-input::placeholder{color:rgba(255,255,255,0.25)}
    .setup-btn{width:100%;padding:14px;border-radius:14px;border:none;background:linear-gradient(135deg,var(--gold),#b8860b);color:white;font-size:15px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif}
    .setup-btn:disabled{opacity:0.4;cursor:not-allowed}
    .setup-note{font-size:11px;color:rgba(255,255,255,0.25);margin-top:16px;line-height:1.5}

    .header{padding:20px 0 8px;display:flex;align-items:center;justify-content:space-between}
    .logo{font-family:'Sora',sans-serif;font-size:22px;font-weight:800;background:linear-gradient(135deg,var(--gold),#e8b44f);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .subtitle{font-size:11px;color:rgba(255,255,255,0.3);letter-spacing:2px;text-transform:uppercase;margin-top:1px}
    .history-btn{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:8px 14px;color:rgba(255,255,255,0.5);font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;font-family:'DM Sans',sans-serif}
    .history-btn.active{background:rgba(200,150,62,0.12);border-color:rgba(200,150,62,0.3);color:var(--gold)}
    .badge{background:var(--gold);color:var(--dark);width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700}
    .settings-btn{background:none;border:none;font-size:18px;cursor:pointer;padding:8px;opacity:0.4}
    .main{text-align:center;padding-top:30px;padding-bottom:16px}
    .main.compact{padding-top:12px}
    .status-title{font-size:18px;font-weight:600;color:rgba(255,255,255,0.85);margin-bottom:6px}
    .status-sub{font-size:13px;color:rgba(255,255,255,0.35)}
    .fb{margin:12px 0;padding:10px 16px;border-radius:12px;font-size:13px;text-align:center;line-height:1.5}
    .fb.info{background:rgba(22,105,122,0.15);border:1px solid rgba(22,105,122,0.3);color:#5dc8d9}
    .fb.ok{background:rgba(39,174,96,0.15);border:1px solid rgba(39,174,96,0.3);color:#5ddb8e}
    .fb.warn{background:rgba(200,150,62,0.15);border:1px solid rgba(200,150,62,0.3);color:#e8c56e}
    .fb.err{background:rgba(214,48,49,0.15);border:1px solid rgba(214,48,49,0.3);color:#e87878}
    .mic-wrap{display:flex;justify-content:center;margin:24px 0 8px}
    .mic-btn{width:120px;height:120px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle,var(--gold) 0%,#b8860b 100%);box-shadow:0 8px 32px rgba(200,150,62,0.35);transition:all 0.3s;outline:none;-webkit-appearance:none}
    .mic-btn.recording{background:radial-gradient(circle,var(--red) 0%,#c0392b 100%);animation:pulse-ring 1.5s ease-out infinite}
    .mic-btn svg{width:48px;height:48px}
    @keyframes pulse-ring{0%{box-shadow:0 0 0 0 rgba(214,48,49,0.5)}50%{box-shadow:0 0 0 20px rgba(214,48,49,0)}100%{box-shadow:0 0 0 0 rgba(214,48,49,0)}}
    .timer{font-size:28px;font-weight:700;color:var(--red);margin:12px 0;font-variant-numeric:tabular-nums}
    .waveform{display:flex;align-items:center;justify-content:center;gap:3px;height:40px;margin:12px 0}
    .wave-bar{width:3px;border-radius:2px;height:4px;background:linear-gradient(to top,var(--gold),var(--teal));opacity:0.15}
    .waveform.active .wave-bar{opacity:0.8;animation:wave 0.8s ease-in-out infinite alternate}
    @keyframes wave{from{height:4px}to{height:32px}}
    .transcript-box{background:rgba(255,255,255,0.06);border-radius:16px;padding:16px 20px;margin:12px 0;border:1px solid rgba(200,150,62,0.15);min-height:60px;max-height:150px;overflow:auto;text-align:left}
    .transcript-label{font-size:11px;color:var(--gold);font-weight:600;letter-spacing:1.5px;margin-bottom:8px;text-transform:uppercase}
    .transcript-text{font-size:15px;line-height:1.6;color:rgba(255,255,255,0.9)}
    .spinner{width:60px;height:60px;border-radius:50%;border:3px solid rgba(200,150,62,0.15);border-top-color:var(--gold);animation:spin 0.8s linear infinite;margin:20px auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    .result-card{background:rgba(255,255,255,0.05);border-radius:20px;overflow:hidden;animation:slideUp 0.4s ease-out;text-align:left}
    .result-header{padding:16px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.06)}
    .result-intent{display:flex;align-items:center;gap:10px}
    .result-label{font-size:14px;font-weight:700;letter-spacing:0.5px}
    .result-tab{font-size:11px;color:rgba(255,255,255,0.4)}
    .conf-badge{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700}
    .result-body{padding:16px 20px}
    .result-clean{font-size:13px;color:rgba(255,255,255,0.85);line-height:1.6;margin-bottom:16px;font-style:italic}
    .data-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .data-field{background:rgba(255,255,255,0.04);border-radius:10px;padding:8px 12px;border:1px solid rgba(255,255,255,0.06)}
    .data-key{font-size:10px;color:rgba(255,255,255,0.35);text-transform:uppercase;letter-spacing:1px;margin-bottom:2px}
    .data-val{font-size:13px;color:rgba(255,255,255,0.9);font-weight:500;word-break:break-word}
    .followup-box{margin-top:12px;background:rgba(123,45,142,0.12);border-radius:12px;padding:10px 14px;border:1px solid rgba(123,45,142,0.2);display:flex;align-items:center;gap:10px}
    .followup-label{font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:2px}
    .followup-text{font-size:13px;color:rgba(255,255,255,0.85)}
    .followup-days{color:var(--gold);font-weight:600;margin-left:6px}
    .tabs-row{margin-top:12px;display:flex;gap:6px;flex-wrap:wrap}
    .tab-chip{font-size:11px;padding:3px 10px;border-radius:12px;background:rgba(15,52,96,0.3);color:rgba(255,255,255,0.6);border:1px solid rgba(15,52,96,0.4)}
    .actions{padding:12px 20px 16px;display:flex;gap:10px}
    .btn-confirm{flex:1;padding:12px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--green),#219a52);color:white;font-size:14px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif}
    .btn-secondary{padding:12px 20px;border-radius:12px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:rgba(255,255,255,0.6);font-size:14px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif}
    .text-input-row{display:flex;gap:8px;margin:12px 0}
    .text-input{flex:1;padding:12px 16px;border-radius:14px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:white;font-size:14px;outline:none;font-family:'DM Sans',sans-serif}
    .text-input::placeholder{color:rgba(255,255,255,0.25)}
    .btn-send{padding:12px 20px;border-radius:14px;border:none;background:var(--gold);color:white;font-size:14px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif}
    .hints{margin-top:24px;margin-bottom:32px}
    .hints-label{font-size:11px;color:rgba(255,255,255,0.25);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px}
    .hints-row{display:flex;flex-wrap:wrap;gap:8px}
    .hint-chip{padding:8px 14px;border-radius:20px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.03);color:rgba(255,255,255,0.4);font-size:12px;cursor:pointer;font-family:'DM Sans',sans-serif;text-align:left}
    .hint-chip:active{border-color:rgba(200,150,62,0.3);color:rgba(255,255,255,0.7)}
    .history-panel{background:rgba(255,255,255,0.03);border-radius:16px;padding:4px 16px;margin-bottom:16px;max-height:240px;overflow:auto;border:1px solid rgba(255,255,255,0.06)}
    .history-item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.05)}
    .history-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
    .history-text{font-size:13px;color:rgba(255,255,255,0.85);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .history-meta{font-size:11px;color:rgba(255,255,255,0.35);margin-top:2px}
    .history-dot{width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0}
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);display:none;align-items:flex-end;justify-content:center;z-index:100}
    .modal-bg.show{display:flex}
    .modal-content{background:var(--dark);border-radius:24px 24px 0 0;width:100%;max-width:480px;max-height:80vh;overflow:auto;padding:24px}
    .modal-title{font-size:16px;font-weight:700;margin-bottom:20px}
    .modal-field{margin-bottom:12px}
    .modal-label{font-size:11px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;display:block}
    .modal-input{width:100%;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:white;font-size:14px;outline:none;font-family:'DM Sans',sans-serif}
    .modal-actions{display:flex;gap:10px;margin-top:20px}
    .footer{text-align:center;padding:16px 0 24px;font-size:10px;color:rgba(255,255,255,0.15);line-height:1.6}
    @keyframes slideUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
    ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:4px}
    .hidden{display:none!important}
  </style>
</head>
<body>
  <div class="blob1"></div><div class="blob2"></div>
  <div class="container">

    <!-- SETUP SCREEN (first time only) -->
    <div id="setupScreen" class="setup-screen">
      <div style="font-size:48px;margin-bottom:16px">ğŸ™ï¸</div>
      <h2>Welcome to VoiceCRM</h2>
      <p>Paste your Google Apps Script Web App URL below to connect.<br>You get this URL when you deploy your Apps Script.</p>
      <input type="text" class="setup-input" id="apiUrlInput" placeholder="https://script.google.com/macros/s/xxxxx/exec">
      <button class="setup-btn" id="setupBtn" onclick="saveApiUrl()">Connect</button>
      <div class="setup-note">Your URL is saved locally on this device only.<br>You only need to do this once.</div>
    </div>

    <!-- MAIN APP (shown after setup) -->
    <div id="appScreen" class="hidden">
      <div class="header">
        <div><div class="logo">VoiceCRM</div><div class="subtitle">AI Voice Assistant</div></div>
        <div style="display:flex;align-items:center;gap:8px">
          <button class="history-btn" id="historyBtn" onclick="toggleHistory()">
            <span style="font-size:14px">ğŸ“‹</span><span class="badge hidden" id="historyBadge">0</span>
          </button>
          <button class="settings-btn" onclick="showSetup()">âš™ï¸</button>
        </div>
      </div>
      <div class="history-panel hidden" id="historyPanel"></div>
      <div class="main" id="mainArea">
        <div id="statusArea">
          <div class="status-title" id="statusTitle">Tap to speak</div>
          <div class="status-sub" id="statusSub">Tell me about a lead, viewing, deal, or follow-up</div>
        </div>
        <div class="mic-wrap" id="micWrap">
          <button class="mic-btn" id="micBtn" onclick="toggleMic()">
            <svg viewBox="0 0 24 24" fill="none" id="micIcon">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" fill="white"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <line x1="12" y1="19" x2="12" y2="23" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <line x1="8" y1="23" x2="16" y2="23" stroke="white" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div class="timer hidden" id="timer">0:00</div>
        <div class="waveform" id="waveform"></div>
        <div id="feedbackBox"></div>
        <div class="transcript-box hidden" id="transcriptBox">
          <div class="transcript-label">Transcription</div>
          <div class="transcript-text" id="transcriptText"></div>
        </div>
        <div class="spinner hidden" id="spinner"></div>
      </div>
      <div id="resultArea" class="hidden"></div>
      <div id="textInputArea">
        <div style="text-align:center;font-size:11px;color:rgba(255,255,255,0.2);margin-bottom:8px">or type your update</div>
        <div class="text-input-row">
          <input type="text" class="text-input" id="textInput" placeholder="Type your update here..." onkeydown="if(event.key==='Enter')submitText()">
          <button class="btn-send" onclick="submitText()">Send</button>
        </div>
      </div>
      <div class="hints" id="hintsArea">
        <div class="hints-label">Try saying...</div>
        <div class="hints-row">
          <button class="hint-chip" onclick="useHint(this)">New lead from Bayut, Mohammed, 2-bed in JLT, budget 1.2 million</button>
          <button class="hint-chip" onclick="useHint(this)">Just showed the Marina apartment to Sarah, she loved it</button>
          <button class="hint-chip" onclick="useHint(this)">Remind me to call Ahmed on Thursday about the offer</button>
          <button class="hint-chip" onclick="useHint(this)">Ahmed accepted the Marina offer, 1.85 million</button>
        </div>
      </div>
      <div class="footer">VoiceCRM by SheetSouq â€¢ AI-Powered Real Estate CRM<br>Supports English, Arabic, Russian & mixed language input</div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-bg" id="editModal" onclick="if(event.target===this)this.classList.remove('show')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-title">Edit Data</div>
      <div id="editFields"></div>
      <div class="modal-actions">
        <button class="btn-confirm" onclick="saveEdit()">Save Changes</button>
        <button class="btn-secondary" onclick="document.getElementById('editModal').classList.remove('show')">Cancel</button>
      </div>
    </div>
  </div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var API_URL = '';
var currentAiResult = null;
var historyItems = [];
var isRecording = false;
var mediaRecorder = null;
var audioChunks = [];
var recordingStartTime = 0;
var timerInterval = null;
var persistentStream = null;
var recorderMimeType = '';

var INTENTS = {
  new_lead:{label:'New Lead',icon:'ğŸ‘¤',color:'#16697A',tab:'Leads'},
  viewing_update:{label:'Viewing Update',icon:'ğŸ ',color:'#C8963E',tab:'Viewings'},
  follow_up:{label:'Follow-Up',icon:'ğŸ“…',color:'#7B2D8E',tab:'FollowUps'},
  deal_update:{label:'Deal Update',icon:'ğŸ¤',color:'#27AE60',tab:'Deals'},
  commission_log:{label:'Commission',icon:'ğŸ’°',color:'#C8963E',tab:'Commissions'},
  property_note:{label:'Property Note',icon:'ğŸ—ï¸',color:'#0F3460',tab:'Properties'},
  general_note:{label:'General Note',icon:'ğŸ“',color:'#1A1A2E',tab:'VoiceLog'}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API COMMUNICATION (replaces google.script.run)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function callAPI(payload) {
  return fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify(payload),
    redirect: 'follow'
  })
  .then(function(response) {
    if (!response.ok) throw new Error('Server error: ' + response.status);
    return response.json();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETUP â€” API URL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkSetup() {
  API_URL = localStorage.getItem('voicecrm_api_url') || '';
  if (API_URL) {
    document.getElementById('setupScreen').classList.add('hidden');
    document.getElementById('appScreen').classList.remove('hidden');
    initApp();
  } else {
    document.getElementById('setupScreen').classList.remove('hidden');
    document.getElementById('appScreen').classList.add('hidden');
  }
}

function saveApiUrl() {
  var url = document.getElementById('apiUrlInput').value.trim();
  if (!url || !url.startsWith('https://script.google.com/')) {
    alert('Please enter a valid Apps Script URL starting with https://script.google.com/');
    return;
  }
  
  var btn = document.getElementById('setupBtn');
  btn.textContent = 'Connecting...';
  btn.disabled = true;
  
  // Test the connection
  fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify({ action: 'ping' }),
    redirect: 'follow'
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.success) {
      localStorage.setItem('voicecrm_api_url', url);
      API_URL = url;
      document.getElementById('setupScreen').classList.add('hidden');
      document.getElementById('appScreen').classList.remove('hidden');
      initApp();
    } else {
      throw new Error(data.error || 'Connection failed');
    }
  })
  .catch(function(err) {
    alert('Could not connect: ' + err.message + '\n\nMake sure:\n1. You deployed as "Anyone" can access\n2. The URL is correct\n3. Try redeploying a new version');
    btn.textContent = 'Connect';
    btn.disabled = false;
  });
}

function showSetup() {
  document.getElementById('apiUrlInput').value = API_URL || '';
  document.getElementById('setupScreen').classList.remove('hidden');
  document.getElementById('appScreen').classList.add('hidden');
  document.getElementById('setupBtn').textContent = 'Connect';
  document.getElementById('setupBtn').disabled = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initApp() {
  // Build waveform bars
  var wf = document.getElementById('waveform');
  if (wf.children.length === 0) {
    for (var i = 0; i < 24; i++) {
      var bar = document.createElement('div');
      bar.className = 'wave-bar';
      bar.style.animationDelay = (i * 0.04) + 's';
      wf.appendChild(bar);
    }
  }
  
  // Pre-acquire mic stream silently (no popup since this is a top-level page)
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(function(stream) { persistentStream = stream; })
      .catch(function() {}); // Silently fail â€” will retry on first tap
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEEDBACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showFB(msg, type) { document.getElementById('feedbackBox').innerHTML = '<div class="fb ' + (type || 'info') + '">' + msg + '</div>'; }
function hideFB() { document.getElementById('feedbackBox').innerHTML = ''; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECORDING TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startTimer() {
  recordingStartTime = Date.now();
  var el = document.getElementById('timer');
  el.classList.remove('hidden');
  timerInterval = setInterval(function() {
    var sec = Math.floor((Date.now() - recordingStartTime) / 1000);
    var m = Math.floor(sec / 60);
    var s = sec % 60;
    el.textContent = m + ':' + (s < 10 ? '0' : '') + s;
  }, 200);
}
function stopTimer() {
  clearInterval(timerInterval);
  document.getElementById('timer').classList.add('hidden');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MIC TOGGLE â€” MediaRecorder
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleMic() {
  if (isRecording) { stopRecording(); } else { startRecording(); }
}

function startRecording() {
  currentAiResult = null;
  audioChunks = [];

  isRecording = true;
  updateMicUI(true);
  document.getElementById('resultArea').classList.add('hidden');
  document.getElementById('textInputArea').classList.add('hidden');
  document.getElementById('hintsArea').classList.add('hidden');
  document.getElementById('transcriptBox').classList.add('hidden');
  document.getElementById('waveform').classList.add('active');
  document.getElementById('statusTitle').textContent = 'Starting mic...';
  document.getElementById('statusTitle').style.color = 'var(--gold)';
  document.getElementById('statusSub').textContent = '';

  if (persistentStream && persistentStream.active) {
    beginRecording(persistentStream);
    return;
  }

  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(function(stream) {
      persistentStream = stream;
      beginRecording(stream);
    })
    .catch(function(err) {
      console.error('getUserMedia error:', err);
      isRecording = false;
      updateMicUI(false);
      if (err.name === 'NotAllowedError') {
        showFB('âŒ <strong>Microphone blocked.</strong> Click the lock icon ğŸ”’ in the address bar â†’ allow Microphone.', 'err');
      } else if (err.name === 'NotFoundError') {
        showFB('âŒ No microphone found on this device.', 'err');
      } else {
        showFB('âŒ Mic error: ' + err.message, 'err');
      }
      document.getElementById('statusTitle').textContent = 'Mic not available';
      document.getElementById('statusTitle').style.color = 'var(--red)';
      document.getElementById('textInputArea').classList.remove('hidden');
    });
}

function beginRecording(stream) {
  var options = {};
  if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
    options.mimeType = 'audio/webm;codecs=opus';
  } else if (MediaRecorder.isTypeSupported('audio/webm')) {
    options.mimeType = 'audio/webm';
  } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
    options.mimeType = 'audio/mp4';
  }
  recorderMimeType = options.mimeType || 'audio/webm';

  mediaRecorder = new MediaRecorder(stream, options);

  mediaRecorder.ondataavailable = function(event) {
    if (event.data && event.data.size > 0) { audioChunks.push(event.data); }
  };

  mediaRecorder.onstop = function() {
    stopTimer();
    if (audioChunks.length === 0) { showFB('No audio captured. Try again.', 'warn'); showIdle(); return; }

    var blob = new Blob(audioChunks, { type: recorderMimeType });
    var seconds = Math.floor((Date.now() - recordingStartTime) / 1000);

    if (seconds < 1) { showFB('Recording too short. Hold longer while you speak.', 'warn'); showIdle(); return; }

    showFB('ğŸµ Recorded ' + seconds + ' seconds. Sending for transcription...', 'ok');
    document.getElementById('micWrap').classList.add('hidden');
    document.getElementById('waveform').classList.add('hidden');
    document.getElementById('spinner').classList.remove('hidden');
    document.getElementById('statusTitle').textContent = 'âš™ï¸ Transcribing & processing...';
    document.getElementById('statusTitle').style.color = 'var(--gold)';
    document.getElementById('statusSub').textContent = 'Whisper AI â†’ Claude AI â†’ structured data';

    var reader = new FileReader();
    reader.onloadend = function() {
      var base64 = reader.result.split(',')[1];
      sendAudioToBackend(base64);
    };
    reader.readAsDataURL(blob);
  };

  mediaRecorder.onerror = function(e) {
    showFB('Recording error: ' + e.error.name, 'err');
    isRecording = false; updateMicUI(false); stopTimer();
  };

  mediaRecorder.start(250);
  startTimer();
  document.getElementById('statusTitle').textContent = 'ğŸ”´ Recording...';
  document.getElementById('statusTitle').style.color = 'var(--red)';
  document.getElementById('statusSub').textContent = 'Speak naturally. Tap â–  when done.';
  showFB('ğŸ™ï¸ <strong>Recording!</strong> Speak now. Tap the red button when finished.', 'ok');
}

function stopRecording() {
  isRecording = false;
  updateMicUI(false);
  document.getElementById('waveform').classList.remove('active');
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
  } else {
    stopTimer(); showIdle();
  }
}

function sendAudioToBackend(base64Audio) {
  showFB('ğŸ“¡ Sending to server...', 'info');
  callAPI({ action: 'processAudio', audio: base64Audio })
    .then(function(result) {
      if (result.success && result.aiResult) {
        currentAiResult = result.aiResult;
        if (result.transcript) {
          document.getElementById('transcriptBox').classList.remove('hidden');
          document.getElementById('transcriptText').textContent = result.transcript;
        }
        showResultUI();
        showFB('âœ“ Transcribed & processed! Review below.', 'ok');
      } else {
        showFB('Error: ' + (result.error || 'Unknown error'), 'err');
        showError(result.error || 'Could not process audio.');
      }
    })
    .catch(function(err) {
      showFB('âŒ Connection error: ' + err.message, 'err');
      showError('Connection failed. Check your internet and API URL.');
    });
}

function updateMicUI(recording) {
  var btn = document.getElementById('micBtn');
  var icon = document.getElementById('micIcon');
  if (recording) {
    btn.classList.add('recording');
    icon.innerHTML = '<rect x="6" y="6" width="12" height="12" rx="2" fill="white"/>';
  } else {
    btn.classList.remove('recording');
    icon.innerHTML = '<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" fill="white"/><path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke="white" stroke-width="2" stroke-linecap="round"/><line x1="12" y1="19" x2="12" y2="23" stroke="white" stroke-width="2" stroke-linecap="round"/><line x1="8" y1="23" x2="16" y2="23" stroke="white" stroke-width="2" stroke-linecap="round"/>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEXT INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function processText(text) {
  document.getElementById('micWrap').classList.add('hidden');
  document.getElementById('waveform').classList.add('hidden');
  document.getElementById('textInputArea').classList.add('hidden');
  document.getElementById('hintsArea').classList.add('hidden');
  document.getElementById('spinner').classList.remove('hidden');
  document.getElementById('statusTitle').textContent = 'âš™ï¸ AI is thinking...';
  document.getElementById('statusTitle').style.color = 'var(--gold)';
  document.getElementById('statusSub').textContent = 'Extracting structured data';
  document.getElementById('transcriptBox').classList.remove('hidden');
  document.getElementById('transcriptText').textContent = text;
  showFB('Sending to Claude AI...', 'info');

  callAPI({ action: 'processText', text: text })
    .then(function(result) {
      if (result.success && result.aiResult) {
        currentAiResult = result.aiResult;
        showResultUI();
        showFB('âœ“ Processed! Review below.', 'ok');
      } else {
        showFB('Error: ' + (result.error || 'Unknown'), 'err');
        showError(result.error || 'AI could not process that.');
      }
    })
    .catch(function(err) {
      showFB('Error: ' + err.message, 'err');
      showError('Connection failed.');
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIRM & WRITE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function confirmResult() {
  if (!currentAiResult) return;
  var btn = document.querySelector('.btn-confirm');
  btn.textContent = 'â³ Saving...'; btn.disabled = true;
  showFB('Writing data to your Google Sheet...', 'info');

  callAPI({ action: 'confirmWrite', aiResult: currentAiResult })
    .then(function(r) {
      if (r.success) {
        historyItems.unshift({ intent: currentAiResult.intent, summary: currentAiResult.summary, tabs: currentAiResult.tabs_affected, timestamp: Date.now() });
        updateHistoryBadge();
        showSaved();
        showFB('âœ“ Saved to sheet!', 'ok');
      } else {
        showFB('Save error: ' + (r.error || 'Unknown'), 'err');
        btn.textContent = 'âœ“ Confirm & Save'; btn.disabled = false;
      }
    })
    .catch(function(err) {
      showFB('Save failed: ' + err.message, 'err');
      btn.textContent = 'âœ“ Confirm & Save'; btn.disabled = false;
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI STATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showIdle() {
  document.getElementById('statusTitle').textContent = 'Tap to speak';
  document.getElementById('statusTitle').style.color = '';
  document.getElementById('statusSub').textContent = 'Tell me about a lead, viewing, deal, or follow-up';
  document.getElementById('micWrap').classList.remove('hidden');
  document.getElementById('waveform').classList.remove('hidden');
  document.getElementById('waveform').classList.remove('active');
  document.getElementById('transcriptBox').classList.add('hidden');
  document.getElementById('spinner').classList.add('hidden');
  document.getElementById('resultArea').classList.add('hidden');
  document.getElementById('textInputArea').classList.remove('hidden');
  document.getElementById('hintsArea').classList.remove('hidden');
  document.getElementById('statusArea').style.display = '';
  document.getElementById('mainArea').classList.remove('compact');
  updateMicUI(false);
}

function showError(msg) {
  document.getElementById('statusTitle').textContent = msg;
  document.getElementById('statusTitle').style.color = 'var(--red)';
  document.getElementById('statusSub').textContent = 'Tap mic to try again or type below';
  document.getElementById('micWrap').classList.remove('hidden');
  document.getElementById('spinner').classList.add('hidden');
  document.getElementById('textInputArea').classList.remove('hidden');
  document.getElementById('hintsArea').classList.remove('hidden');
  updateMicUI(false);
}

function showResultUI() {
  document.getElementById('statusArea').style.display = 'none';
  document.getElementById('micWrap').classList.add('hidden');
  document.getElementById('waveform').classList.add('hidden');
  document.getElementById('spinner').classList.add('hidden');
  document.getElementById('resultArea').classList.remove('hidden');
  document.getElementById('mainArea').classList.add('compact');
  renderResult();
}

function showSaved() {
  document.getElementById('resultArea').classList.add('hidden');
  document.getElementById('transcriptBox').classList.add('hidden');
  document.getElementById('statusArea').style.display = '';
  document.getElementById('statusArea').innerHTML = '<div style="font-size:48px;margin-bottom:8px">âœ…</div><div class="status-title" style="color:var(--green)">Saved to Sheet!</div><div class="status-sub">Data written successfully</div>';
  setTimeout(function() {
    document.getElementById('statusArea').innerHTML = '<div class="status-title" id="statusTitle"></div><div class="status-sub" id="statusSub"></div>';
    currentAiResult = null; hideFB(); showIdle();
  }, 2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER RESULT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderResult() {
  var r = currentAiResult; if (!r) return;
  var intent = INTENTS[r.intent] || INTENTS.general_note;
  var conf = Math.round((r.confidence || 0) * 100);
  var cc = conf >= 85 ? 'var(--green)' : conf >= 70 ? 'var(--gold)' : 'var(--red)';
  var h = '<div class="result-card" style="border:1px solid ' + intent.color + '33">';
  h += '<div class="result-header" style="background:linear-gradient(135deg,' + intent.color + '15,' + intent.color + '05)">';
  h += '<div class="result-intent"><span style="font-size:24px">' + intent.icon + '</span><div><div class="result-label" style="color:' + intent.color + '">' + intent.label + '</div><div class="result-tab">â†’ ' + intent.tab + ' tab</div></div></div>';
  h += '<div class="conf-badge" style="background:' + cc + '22;color:' + cc + '">' + conf + '%</div></div>';
  h += '<div class="result-body"><div class="result-clean">"' + esc(r.clean_text || '') + '"</div>';
  if (r.data) {
    h += '<div class="data-grid">';
    var keys = Object.keys(r.data);
    for (var i = 0; i < keys.length; i++) {
      var k = keys[i], v = r.data[k];
      if (v === null || v === undefined || v === '') continue;
      var label = k.replace(/_/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); });
      var dv = v; if (typeof v === 'number' && v > 1000) dv = 'AED ' + v.toLocaleString();
      h += '<div class="data-field"><div class="data-key">' + esc(label) + '</div><div class="data-val">' + esc(String(dv)) + '</div></div>';
    }
    h += '</div>';
  }
  if (r.follow_up_suggestion) {
    h += '<div class="followup-box"><span style="font-size:16px">ğŸ“…</span><div><div class="followup-label">Auto Follow-Up</div>';
    h += '<div class="followup-text">' + esc(r.follow_up_suggestion.action) + '<span class="followup-days"> in ' + r.follow_up_suggestion.due_days + ' day' + (r.follow_up_suggestion.due_days !== 1 ? 's' : '') + '</span></div></div></div>';
  }
  if (r.tabs_affected && r.tabs_affected.length > 0) {
    h += '<div class="tabs-row">';
    for (var j = 0; j < r.tabs_affected.length; j++) h += '<span class="tab-chip">âœ ' + esc(r.tabs_affected[j]) + '</span>';
    h += '</div>';
  }
  h += '</div><div class="actions">';
  h += '<button class="btn-confirm" onclick="confirmResult()">âœ“ Confirm & Save</button>';
  h += '<button class="btn-secondary" onclick="openEditModal()">Edit</button>';
  h += '<button class="btn-secondary" onclick="hideFB();showIdle()">Retry</button>';
  h += '</div></div>';
  document.getElementById('resultArea').innerHTML = h;
}

function esc(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDIT MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openEditModal() {
  if (!currentAiResult || !currentAiResult.data) return;
  var d = currentAiResult.data, h = '', keys = Object.keys(d);
  for (var i = 0; i < keys.length; i++) {
    var k = keys[i], v = d[k]; if (v === null || v === undefined) v = '';
    var label = k.replace(/_/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); });
    h += '<div class="modal-field"><label class="modal-label">' + esc(label) + '</label>';
    h += '<input class="modal-input" data-key="' + k + '" value="' + esc(String(v)) + '"></div>';
  }
  document.getElementById('editFields').innerHTML = h;
  document.getElementById('editModal').classList.add('show');
}
function saveEdit() {
  var inputs = document.querySelectorAll('#editFields .modal-input');
  for (var i = 0; i < inputs.length; i++) {
    var k = inputs[i].getAttribute('data-key'), v = inputs[i].value;
    if (!isNaN(v) && v.trim() !== '') v = Number(v); currentAiResult.data[k] = v;
  }
  document.getElementById('editModal').classList.remove('show'); renderResult();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEXT & HINTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function submitText() { var input = document.getElementById('textInput'), t = input.value.trim(); if (t.length > 2) { input.value = ''; processText(t); } }
function useHint(el) { processText(el.textContent); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleHistory() {
  var p = document.getElementById('historyPanel'), b = document.getElementById('historyBtn');
  if (!p.classList.contains('hidden')) { p.classList.add('hidden'); b.classList.remove('active'); return; }
  if (historyItems.length === 0) return;
  p.classList.remove('hidden'); b.classList.add('active');
  var h = '';
  for (var i = 0; i < historyItems.length; i++) {
    var it = historyItems[i], intent = INTENTS[it.intent] || INTENTS.general_note;
    var mins = Math.floor((Date.now() - it.timestamp) / 60000);
    var ago = mins < 1 ? 'just now' : mins < 60 ? mins + 'm ago' : Math.floor(mins / 60) + 'h ago';
    h += '<div class="history-item"><div class="history-icon" style="background:' + intent.color + '22">' + intent.icon + '</div>';
    h += '<div style="flex:1;min-width:0"><div class="history-text">' + esc(it.summary || 'Entry') + '</div>';
    h += '<div class="history-meta">' + intent.label + ' â†’ ' + intent.tab + ' â€¢ ' + ago + '</div></div>';
    h += '<div class="history-dot"></div></div>';
  }
  p.innerHTML = h;
}
function updateHistoryBadge() { var b = document.getElementById('historyBadge'); if (historyItems.length > 0) { b.textContent = historyItems.length; b.classList.remove('hidden'); } }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onload = function() { checkSetup(); };
</script>
</body>
</html>
