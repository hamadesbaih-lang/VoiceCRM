<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0e1a">
  <title>VoiceCRM</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ™ï¸</text></svg>">
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Outfit:wght@700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0e1a;--bg2:#0f1424;--bg3:#141a2e;
      --gold:#d4a24e;--gold2:#e8b85c;--gold-glow:rgba(212,162,78,.25);
      --teal:#1da2b4;--teal2:#25c4d8;--teal-glow:rgba(29,162,180,.2);
      --green:#2dd47a;--green2:#3ee88c;--green-glow:rgba(45,212,122,.2);
      --red:#ef5350;--red2:#ff6b6b;--red-glow:rgba(239,83,80,.2);
      --purple:#a855f7;--purple-glow:rgba(168,85,247,.15);
      --yellow:#fbbf24;--yellow-glow:rgba(251,191,36,.15);
      --glass:rgba(255,255,255,.04);--glass2:rgba(255,255,255,.07);--glass3:rgba(255,255,255,.1);
      --border:rgba(255,255,255,.08);--border2:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);--text2:rgba(255,255,255,.6);--text3:rgba(255,255,255,.35);
      --safe-top:env(safe-area-inset-top,20px);--safe-bottom:env(safe-area-inset-bottom,0px);
      --radius:18px;--radius-sm:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    html{height:100%;overflow:hidden;background:var(--bg)}
    body{height:100%;overflow:hidden;font-family:'Plus Jakarta Sans',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text);margin:0;font-size:14px;line-height:1.5;-webkit-font-smoothing:antialiased}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTH GATE */
    .auth-wall{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:40px 24px}
    .auth-wall.passed{display:none}
    .auth-wall-spinner{width:40px;height:40px;border:3px solid rgba(255,255,255,.06);border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite;margin-bottom:20px}
    .auth-wall-text{font-size:14px;color:var(--text3)}
    .auth-wall-logo{font-family:'Outfit',sans-serif;font-size:28px;font-weight:900;background:linear-gradient(135deg,var(--gold),var(--gold2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:24px}
    .auth-fail{display:none;flex-direction:column;align-items:center;gap:16px}
    .auth-fail.show{display:flex}
    .auth-fail-icon{width:64px;height:64px;border-radius:20px;background:rgba(239,83,80,.08);border:1px solid rgba(239,83,80,.15);display:flex;align-items:center;justify-content:center;font-size:28px}
    .auth-fail-title{font-family:'Outfit',sans-serif;font-size:22px;font-weight:800}
    .auth-fail-msg{font-size:14px;color:var(--text2);line-height:1.6;max-width:300px}
    .auth-fail-btn{padding:14px 32px;border-radius:var(--radius-sm);border:none;background:linear-gradient(135deg,var(--gold),#b8860b);color:#fff;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;box-shadow:0 4px 20px rgba(212,162,78,.3);margin-top:8px}
    /* Logout button in header */
    .logout-btn{width:36px;height:36px;border-radius:12px;background:rgba(239,83,80,.08);border:1px solid rgba(239,83,80,.12);display:flex;align-items:center;justify-content:center;cursor:pointer}
    .logout-btn svg{width:16px;height:16px;stroke:var(--red);stroke-width:1.8;fill:none;stroke-linecap:round;stroke-linejoin:round}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAYWALL */
    .paywall{position:fixed;inset:0;background:var(--bg);z-index:9998;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:40px 24px;overflow-y:auto}
    .paywall.hidden{display:none}
    .pw-logo{font-family:'Outfit',sans-serif;font-size:32px;font-weight:900;background:linear-gradient(135deg,var(--gold),var(--gold2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
    .pw-sub{font-size:11px;color:var(--text3);letter-spacing:3px;text-transform:uppercase;margin-bottom:32px}
    .pw-icon{width:80px;height:80px;border-radius:24px;background:linear-gradient(135deg,rgba(212,162,78,.12),rgba(212,162,78,.04));border:1px solid rgba(212,162,78,.2);display:flex;align-items:center;justify-content:center;margin-bottom:24px}
    .pw-icon svg{width:40px;height:40px;stroke:var(--gold);stroke-width:1.5;fill:none}
    .pw-title{font-family:'Outfit',sans-serif;font-size:24px;font-weight:800;margin-bottom:8px;color:#fff}
    .pw-msg{font-size:14px;color:var(--text2);line-height:1.7;max-width:340px;margin-bottom:28px}
    .pw-price-box{background:var(--glass);border:1px solid var(--border);border-radius:var(--radius);padding:24px;width:100%;max-width:340px;margin-bottom:16px}
    .pw-price-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .pw-price-row:last-child{margin-bottom:0}
    .pw-price-label{font-size:14px;color:var(--text2)}
    .pw-price-value{font-family:'Outfit',sans-serif;font-size:18px;font-weight:800;color:var(--gold2)}
    .pw-price-note{font-size:11px;color:var(--text3)}
    .pw-divider{height:1px;background:var(--border);margin:12px 0}
    .pw-features{width:100%;max-width:340px;margin-bottom:28px;text-align:left}
    .pw-feat{display:flex;align-items:center;gap:10px;padding:8px 0;font-size:13px;color:var(--text2)}
    .pw-feat-icon{width:20px;height:20px;border-radius:6px;background:rgba(45,212,122,.1);display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .pw-feat-icon svg{width:12px;height:12px;stroke:var(--green);stroke-width:2.5}
    .pw-cta{width:100%;max-width:340px;padding:16px;border-radius:var(--radius-sm);border:none;background:linear-gradient(135deg,var(--gold),#b8860b);color:#fff;font-size:16px;font-weight:700;cursor:pointer;font-family:inherit;box-shadow:0 4px 24px rgba(212,162,78,.35);margin-bottom:12px;transition:transform .15s,box-shadow .15s}
    .pw-cta:active{transform:scale(.98)}
    .pw-cta:disabled{opacity:.6;cursor:not-allowed}
    .pw-cta-sub{font-size:12px;color:var(--text3);margin-bottom:8px}
    .pw-portal{font-size:13px;color:var(--gold);cursor:pointer;text-decoration:underline;background:none;border:none;font-family:inherit;margin-bottom:20px}
    .pw-logout-link{font-size:12px;color:var(--text3);cursor:pointer;background:none;border:none;font-family:inherit;text-decoration:underline;margin-top:8px}
    .pw-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:.5px;text-transform:uppercase}
    .pw-badge.expired{background:rgba(239,83,80,.1);color:var(--red);border:1px solid rgba(239,83,80,.15)}
    .pw-badge.past-due{background:rgba(251,191,36,.1);color:var(--yellow);border:1px solid rgba(251,191,36,.15)}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TRIAL BANNER */
    .trial-banner{display:none;padding:6px 16px;text-align:center;font-size:12px;font-weight:600;cursor:pointer;transition:background .2s}
    .trial-banner.show{display:block}
    .trial-banner.ok{background:linear-gradient(90deg,rgba(29,162,180,.15),rgba(29,162,180,.05));color:var(--teal2);border-bottom:1px solid rgba(29,162,180,.15)}
    .trial-banner.warn{background:linear-gradient(90deg,rgba(251,191,36,.15),rgba(251,191,36,.05));color:var(--yellow);border-bottom:1px solid rgba(251,191,36,.15)}
    .trial-banner.urgent{background:linear-gradient(90deg,rgba(239,83,80,.15),rgba(239,83,80,.05));color:var(--red);border-bottom:1px solid rgba(239,83,80,.15)}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SHELL */
    .app{position:fixed;inset:0;display:flex;flex-direction:column;background:var(--bg);overflow:hidden}
    /* Ambient glow orbs */
    .app::before{content:'';position:fixed;top:-120px;right:-80px;width:300px;height:300px;border-radius:50%;background:radial-gradient(circle,rgba(212,162,78,.08),transparent 70%);pointer-events:none;z-index:0}
    .app::after{content:'';position:fixed;bottom:-100px;left:-60px;width:280px;height:280px;border-radius:50%;background:radial-gradient(circle,rgba(29,162,180,.06),transparent 70%);pointer-events:none;z-index:0}

    .app-header{flex-shrink:0;padding:10px 22px 8px;padding-top:calc(var(--safe-top) + 10px);display:flex;align-items:center;justify-content:space-between;position:relative;z-index:1}
    .logo{font-family:'Outfit',sans-serif;font-size:22px;font-weight:900;background:linear-gradient(135deg,var(--gold),var(--gold2),#f0cc72);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-.3px}
    .logo-sub{font-size:9px;color:var(--text3);letter-spacing:3px;text-transform:uppercase;margin-top:-2px}
    .hdr-btns{display:flex;gap:8px}
    .icon-btn{background:var(--glass2);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid var(--border);border-radius:12px;padding:8px 11px;color:var(--text2);font-size:15px;cursor:pointer;line-height:1;transition:all .2s}
    .icon-btn:active{background:var(--glass3);transform:scale(.95)}

    .screens{flex:1;overflow:hidden;position:relative;z-index:1}
    .scr{position:absolute;inset:0;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:0 20px 24px;display:none;opacity:0;transition:opacity .25s ease}
    .scr.on{display:block;opacity:1}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BOTTOM NAV â€” Frosted Glass */
    .bnav{flex-shrink:0;display:flex;align-items:stretch;background:rgba(10,14,26,.88);backdrop-filter:blur(24px) saturate(1.5);-webkit-backdrop-filter:blur(24px) saturate(1.5);border-top:1px solid rgba(255,255,255,.06);padding:0 6px;padding-bottom:var(--safe-bottom);position:relative;z-index:2}
    .bnav::before{content:'';position:absolute;top:0;left:20%;right:20%;height:1px;background:linear-gradient(90deg,transparent,rgba(212,162,78,.3),transparent)}
    .bnav-i{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;padding:6px 0;cursor:pointer;border-radius:0;transition:all .25s}
    .bnav-i.on{background:rgba(212,162,78,.08)}
    .bnav-ic{line-height:1;transition:transform .2s;display:flex;align-items:center;justify-content:center}
    .bnav-ic svg{width:24px;height:24px;stroke:var(--text3);stroke-width:1.8;fill:none;stroke-linecap:round;stroke-linejoin:round;transition:stroke .25s}
    .bnav-i.on .bnav-ic svg{stroke:var(--gold)}
    .bnav-lb{font-size:11px;font-weight:700;color:var(--text3);letter-spacing:.3px;transition:color .25s}
    .bnav-i.on .bnav-lb{color:var(--gold)}
    .bnav-center{position:relative;top:-14px;flex:1.3}
    .bnav-center .bnav-lb{margin-top:8px}
    .bnav-center.on{background:none}
    .bnav-mic{width:68px;height:68px;border-radius:50%;background:linear-gradient(145deg,var(--gold),#b8860b,var(--gold));display:flex;align-items:center;justify-content:center;box-shadow:0 8px 32px rgba(212,162,78,.45),0 0 0 3px rgba(212,162,78,.12);transition:all .25s}
    .bnav-center.on .bnav-mic{box-shadow:0 8px 36px rgba(212,162,78,.55),0 0 0 4px rgba(212,162,78,.2);transform:scale(1.05)}
    .bnav-mic svg{width:32px;height:32px}
    .bnav-mic.recording{background:linear-gradient(145deg,var(--red),#c0392b);box-shadow:0 8px 32px rgba(239,83,80,.5),0 0 0 3px rgba(239,83,80,.2);animation:navPulse 1.5s ease-out infinite;transform:scale(1.12)}
    @keyframes navPulse{0%{box-shadow:0 0 0 3px rgba(239,83,80,.3),0 0 0 6px rgba(239,83,80,.1)}50%{box-shadow:0 0 0 10px rgba(239,83,80,.15),0 0 0 24px rgba(239,83,80,0)}100%{box-shadow:0 0 0 3px rgba(239,83,80,.3),0 0 0 6px rgba(239,83,80,.1)}}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETUP */
    .su-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100%;padding:40px 0;text-align:center}
    .su-wrap h2{font-family:'Outfit',sans-serif;font-size:24px;margin-bottom:8px;color:var(--gold);letter-spacing:-.3px}
    .su-wrap p{font-size:14px;color:var(--text2);margin-bottom:28px;line-height:1.6}
    .su-inp{width:100%;max-width:360px;padding:15px 18px;border-radius:var(--radius-sm);border:1px solid var(--border2);background:var(--glass2);backdrop-filter:blur(12px);color:#fff;font-size:14px;outline:none;font-family:inherit;margin-bottom:14px;transition:border-color .2s}
    .su-inp:focus{border-color:rgba(212,162,78,.4)}
    .su-inp::placeholder{color:var(--text3)}
    .su-btn{width:100%;max-width:360px;padding:15px;border-radius:var(--radius-sm);border:none;background:linear-gradient(135deg,var(--gold),#b8860b);color:#fff;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;box-shadow:0 4px 20px rgba(212,162,78,.3);transition:all .2s}
    .su-btn:active{transform:scale(.98)}
    .su-btn:disabled{opacity:.4;box-shadow:none}
    .su-note{font-size:12px;color:var(--text3);margin-top:20px;line-height:1.5}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SHARED / GLASS COMPONENTS */
    .loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 0;gap:18px}
    .spinner{width:44px;height:44px;border-radius:50%;border:3px solid rgba(212,162,78,.1);border-top-color:var(--gold);animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .empty{text-align:center;padding:50px 24px;color:var(--text3);font-size:14px;line-height:1.7}
    .empty-icon{font-size:48px;margin-bottom:14px;opacity:.6}

    .section{margin-bottom:20px}
    .sec-h{font-size:15px;font-weight:700;color:var(--text);margin-bottom:12px;display:flex;align-items:center;gap:8px;letter-spacing:-.2px}

    /* Glass Card */
    .card{background:var(--glass);backdrop-filter:blur(16px) saturate(1.3);-webkit-backdrop-filter:blur(16px) saturate(1.3);border-radius:var(--radius);border:1px solid var(--border);box-shadow:0 4px 24px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.04);overflow:hidden}

    .open-sheet{display:block;text-align:center;padding:16px;margin:20px 0;border-radius:var(--radius-sm);background:var(--glass);backdrop-filter:blur(12px);border:1px solid rgba(212,162,78,.15);color:var(--gold);font-size:14px;font-weight:700;text-decoration:none;letter-spacing:.3px;transition:all .2s;box-shadow:0 2px 12px rgba(0,0,0,.15)}
    .open-sheet:active{transform:scale(.98);background:var(--glass2)}
    .footer{text-align:center;padding:24px 0 8px;font-size:10px;color:rgba(255,255,255,.1);letter-spacing:1px}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD */
    .dg{font-size:22px;font-weight:800;margin:14px 0 4px;color:var(--text);font-family:'Outfit',sans-serif;letter-spacing:-.3px}
    .dd{font-size:13px;color:var(--text3);margin-bottom:20px}

    /* KPI Cards â€” Premium Glass */
    .kg{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:20px}
    .kc{background:var(--glass);backdrop-filter:blur(20px) saturate(1.4);-webkit-backdrop-filter:blur(20px) saturate(1.4);border-radius:var(--radius);padding:16px 10px 14px;border:1px solid var(--border);text-align:center;position:relative;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.05);transition:transform .2s}
    .kc:active{transform:scale(.97)}
    /* Top glow bar */
    .kc::before{content:'';position:absolute;top:0;left:10%;right:10%;height:2px;border-radius:0 0 2px 2px}
    .kc::after{content:'';position:absolute;top:0;left:20%;right:20%;height:20px;border-radius:50%;filter:blur(12px);opacity:.6}
    .kc.bl::before,.kc.bl::after{background:var(--teal)}.kc.gr::before,.kc.gr::after{background:var(--green)}.kc.go::before,.kc.go::after{background:var(--gold)}.kc.pu::before,.kc.pu::after{background:var(--purple)}.kc.ye::before,.kc.ye::after{background:var(--yellow)}.kc.re::before,.kc.re::after{background:var(--red)}
    .kn{font-size:32px;font-weight:900;font-family:'Outfit',sans-serif;line-height:1;position:relative}
    .kc.bl .kn{color:var(--teal2)}.kc.gr .kn{color:var(--green2)}.kc.go .kn{color:var(--gold2)}.kc.pu .kn{color:var(--purple)}.kc.ye .kn{color:var(--yellow)}.kc.re .kn{color:var(--red2)}
    .kl{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-top:6px;font-weight:700}

    /* Conversion Bar */
    .cvb{background:var(--glass);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-radius:var(--radius-sm);padding:14px 18px;margin-bottom:20px;border:1px solid var(--border);box-shadow:0 2px 12px rgba(0,0,0,.15)}
    .cvb-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .cvb-l{font-size:12px;color:var(--text2);font-weight:600}
    .cvb-p{font-size:22px;font-weight:900;color:var(--green);font-family:'Outfit',sans-serif}
    .cvb-t{height:8px;background:rgba(255,255,255,.06);border-radius:8px;overflow:hidden}
    .cvb-f{height:100%;background:linear-gradient(90deg,var(--green),var(--green2));border-radius:8px;transition:width .8s ease;box-shadow:0 0 12px var(--green-glow)}
    .cvb-s{font-size:11px;color:var(--text3);margin-top:8px;text-align:right}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ROWS â€” Task / Lead / Deal */
    .row{display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.04);gap:12px;transition:background .15s}
    .row:last-child{border-bottom:none}
    .row:active{background:rgba(255,255,255,.03)}
    .row-bar{width:4px;height:32px;border-radius:4px;flex-shrink:0;box-shadow:0 0 8px var(--gold-glow)}
    .row-bar.high,.row-bar.overdue{background:var(--red);box-shadow:0 0 10px var(--red-glow)}
    .row-bar.medium,.row-bar.today{background:var(--gold);box-shadow:0 0 10px var(--gold-glow)}
    .row-bar.low,.row-bar.upcoming{background:var(--teal);box-shadow:0 0 10px var(--teal-glow)}
    .row-bar.done{background:var(--green);box-shadow:0 0 10px var(--green-glow)}
    .row-body{flex:1;min-width:0}
    .row-title{font-size:14px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:-.1px}
    .row-sub{font-size:12px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
    .row-badge{font-size:11px;font-weight:700;padding:4px 10px;border-radius:10px;flex-shrink:0;white-space:nowrap;letter-spacing:.2px}
    .badge-red{background:rgba(239,83,80,.12);color:var(--red2);border:1px solid rgba(239,83,80,.15)}
    .badge-gold{background:rgba(212,162,78,.1);color:var(--gold2);border:1px solid rgba(212,162,78,.12)}
    .badge-blue{background:rgba(29,162,180,.1);color:var(--teal2);border:1px solid rgba(29,162,180,.12)}
    .badge-green{background:rgba(45,212,122,.1);color:var(--green2);border:1px solid rgba(45,212,122,.12)}
    .badge-purple{background:rgba(168,85,247,.1);color:var(--purple);border:1px solid rgba(168,85,247,.12)}

    .check-btn{width:36px;height:36px;border-radius:50%;border:2px solid rgba(255,255,255,.12);background:var(--glass);backdrop-filter:blur(8px);color:var(--text3);font-size:15px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .25s}
    .check-btn:active{background:var(--green);border-color:var(--green);color:#fff;transform:scale(1.15);box-shadow:0 0 16px var(--green-glow)}

    .call-btn{width:40px;height:40px;border-radius:50%;border:1px solid rgba(45,212,122,.15);background:rgba(45,212,122,.08);color:var(--green2);font-size:18px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;text-decoration:none;transition:all .2s}
    .call-btn:active{background:rgba(45,212,122,.2);transform:scale(1.1);box-shadow:0 0 16px var(--green-glow)}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• COMMISSIONS */
    .comm-grid{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:rgba(255,255,255,.04)}
    .comm-item{text-align:center;padding:16px 12px;background:var(--bg2)}
    .comm-item:first-child{border-radius:var(--radius) 0 0 0}.comm-item:nth-child(2){border-radius:0 var(--radius) 0 0}.comm-item:nth-child(3){border-radius:0 0 0 var(--radius)}.comm-item:last-child{border-radius:0 0 var(--radius) 0}
    .comm-val{font-size:18px;font-weight:800;font-family:'Outfit',sans-serif;letter-spacing:-.3px}
    .comm-lbl{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-top:4px;font-weight:600}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VOICE */
    .vw{display:flex;flex-direction:column;align-items:center;min-height:100%;justify-content:center;text-align:center;padding-bottom:20px}
    .st{font-size:20px;font-weight:700;color:var(--text);margin-bottom:8px;letter-spacing:-.2px}
    .ss{font-size:14px;color:var(--text3)}
    .fb{margin:14px 0;padding:12px 18px;border-radius:var(--radius-sm);font-size:14px;text-align:center;line-height:1.6;width:100%;max-width:400px;backdrop-filter:blur(12px)}
    .fb.info{background:rgba(29,162,180,.1);border:1px solid rgba(29,162,180,.2);color:var(--teal2)}
    .fb.ok{background:rgba(45,212,122,.1);border:1px solid rgba(45,212,122,.2);color:var(--green2)}
    .fb.warn{background:rgba(212,162,78,.1);border:1px solid rgba(212,162,78,.2);color:var(--gold2)}
    .fb.err{background:rgba(239,83,80,.1);border:1px solid rgba(239,83,80,.2);color:var(--red2)}
    .wf{display:flex;align-items:center;justify-content:center;gap:3px;height:48px;margin:16px 0}
    .wb{width:3px;border-radius:2px;height:4px;background:linear-gradient(to top,var(--gold),var(--teal));opacity:.12}
    .wf.on .wb{opacity:.85;animation:wv .8s ease-in-out infinite alternate}
    @keyframes wv{from{height:4px}to{height:36px}}
    .tm{font-size:32px;font-weight:800;color:var(--red);margin:16px 0;font-variant-numeric:tabular-nums;font-family:'Outfit',sans-serif}
    .tb{background:var(--glass);backdrop-filter:blur(16px);border-radius:var(--radius);padding:18px 22px;margin:14px 0;border:1px solid rgba(212,162,78,.12);max-height:130px;overflow:auto;text-align:left;width:100%}
    .tl{font-size:11px;color:var(--gold);font-weight:700;letter-spacing:2px;margin-bottom:10px;text-transform:uppercase}
    .tt{font-size:16px;line-height:1.7;color:var(--text)}
    .tir{display:flex;gap:10px;width:100%;max-width:420px;margin:16px 0}
    .ti{flex:1;padding:14px 18px;border-radius:var(--radius-sm);border:1px solid var(--border2);background:var(--glass2);backdrop-filter:blur(12px);color:#fff;font-size:14px;outline:none;font-family:inherit;transition:border-color .2s}
    .ti:focus{border-color:rgba(212,162,78,.4)}
    .ti::placeholder{color:var(--text3)}
    .bs{padding:14px 22px;border-radius:var(--radius-sm);border:none;background:linear-gradient(135deg,var(--gold),#b8860b);color:#fff;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;box-shadow:0 4px 16px rgba(212,162,78,.25);transition:all .2s}
    .bs:active{transform:scale(.97)}
    .hr{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:20px}
    .hc{padding:10px 16px;border-radius:24px;border:1px solid var(--border);background:var(--glass);backdrop-filter:blur(8px);color:var(--text2);font-size:13px;cursor:pointer;font-family:inherit;text-align:left;transition:all .2s;line-height:1.4}
    .hc:active{background:var(--glass2);border-color:var(--border2)}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESULT CARD */
    .rc{background:var(--glass);backdrop-filter:blur(20px) saturate(1.3);-webkit-backdrop-filter:blur(20px) saturate(1.3);border-radius:22px;overflow:hidden;text-align:left;width:100%;max-width:440px;animation:su .4s ease-out;box-shadow:0 8px 40px rgba(0,0,0,.3),inset 0 1px 0 rgba(255,255,255,.05)}
    .rh{padding:16px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,.06)}
    .ri{display:flex;align-items:center;gap:12px}
    .rl{font-size:15px;font-weight:800;letter-spacing:.3px}
    .rt2{font-size:12px;color:var(--text3)}
    .cbg{padding:5px 14px;border-radius:20px;font-size:13px;font-weight:800}
    .rb{padding:16px 20px}
    .rcl{font-size:14px;color:var(--text);line-height:1.7;margin-bottom:16px;font-style:italic;opacity:.85}
    .dg2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .df{background:var(--glass2);border-radius:12px;padding:10px 14px;border:1px solid var(--border)}
    .dk{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:3px;font-weight:600}
    .dv{font-size:14px;color:var(--text);font-weight:600;word-break:break-word}
    .fub{margin-top:14px;background:var(--purple-glow);border-radius:14px;padding:12px 16px;border:1px solid rgba(168,85,247,.15);display:flex;align-items:center;gap:12px}
    .ful{font-size:11px;color:var(--text2);margin-bottom:2px}
    .fut{font-size:14px;color:var(--text)}
    .fud{color:var(--gold);font-weight:700;margin-left:6px}
    .act{padding:14px 20px 18px;display:flex;gap:10px}
    .bcf{flex:1;padding:14px;border-radius:14px;border:none;background:linear-gradient(135deg,var(--green),#1fb866);color:#fff;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;box-shadow:0 4px 20px var(--green-glow);transition:all .2s}
    .bcf:active{transform:scale(.97)}
    .bsc{padding:14px 20px;border-radius:14px;border:1px solid var(--border2);background:var(--glass);backdrop-filter:blur(8px);color:var(--text2);font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s}
    .bsc:active{background:var(--glass2)}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL */
    .mbg{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(12px);display:none;align-items:flex-end;justify-content:center;z-index:100}
    .mbg.show{display:flex}
    .mc{background:var(--bg2);border-radius:24px 24px 0 0;width:100%;max-width:480px;max-height:80vh;overflow:auto;padding:28px;padding-bottom:calc(28px + var(--safe-bottom));border:1px solid var(--border);border-bottom:none}
    .mt2{font-size:18px;font-weight:800;margin-bottom:22px;font-family:'Outfit',sans-serif}
    .mf{margin-bottom:14px}
    .mlb{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:6px;display:block;font-weight:600}
    .mi{width:100%;padding:12px 16px;border-radius:12px;border:1px solid var(--border2);background:var(--glass2);color:#fff;font-size:14px;outline:none;font-family:inherit;transition:border-color .2s}
    .mi:focus{border-color:rgba(212,162,78,.4)}
    .ma{display:flex;gap:10px;margin-top:24px}

    @keyframes su{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:4px}
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ONBOARDING WIZARD */
    .wiz{position:fixed;inset:0;background:var(--bg);z-index:200;display:flex;flex-direction:column;overflow:hidden}
    .wiz.hidden{display:none}
    .wiz-slides{flex:1;position:relative;overflow:hidden}
    .wiz-slide{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 32px;text-align:center;opacity:0;transform:translateX(60px);transition:all .4s ease;pointer-events:none}
    .wiz-slide.active{opacity:1;transform:translateX(0);pointer-events:auto}
    .wiz-slide.exit{opacity:0;transform:translateX(-60px)}
    .wiz-icon{width:120px;height:120px;margin-bottom:32px;display:flex;align-items:center;justify-content:center;border-radius:32px;background:var(--glass2);border:1px solid var(--border);box-shadow:0 8px 40px rgba(0,0,0,.25)}
    .wiz-icon svg{width:56px;height:56px;stroke-width:1.5;stroke-linecap:round;stroke-linejoin:round;fill:none}
    .wiz-title{font-family:'Outfit',sans-serif;font-size:26px;font-weight:800;color:var(--text);margin-bottom:12px;letter-spacing:-.3px;line-height:1.2}
    .wiz-desc{font-size:15px;color:var(--text2);line-height:1.7;max-width:320px}
    .wiz-desc strong{color:var(--text);font-weight:700}
    .wiz-footer{flex-shrink:0;padding:20px 32px;padding-bottom:calc(var(--safe-bottom) + 24px);display:flex;align-items:center;justify-content:space-between;gap:16px}
    .wiz-dots{display:flex;gap:8px;align-items:center}
    .wiz-dot{width:8px;height:8px;border-radius:50%;background:var(--glass3);transition:all .3s}
    .wiz-dot.on{width:24px;border-radius:4px;background:var(--gold)}
    .wiz-skip{background:none;border:none;color:var(--text3);font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;padding:10px 0}
    .wiz-next{padding:14px 32px;border-radius:var(--radius-sm);border:none;background:linear-gradient(135deg,var(--gold),#b8860b);color:#fff;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;box-shadow:0 4px 20px rgba(212,162,78,.3);transition:all .2s}
    .wiz-next:active{transform:scale(.97)}
    .wiz-tag{display:inline-block;padding:5px 12px;border-radius:10px;font-size:11px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;margin-bottom:20px}

    .hidden{display:none!important}
  </style>
</head>
<body>

<!-- â•â•â• AUTH GATE â€” Blocks everything until verified â•â•â• -->
<div id="authWall" class="auth-wall">
  <div id="authChecking">
    <div class="auth-wall-logo">VoiceCRM</div>
    <div class="auth-wall-spinner"></div>
    <div class="auth-wall-text">Verifying access...</div>
  </div>
  <div id="authFailed" class="auth-fail">
    <div class="auth-fail-icon">ğŸ”’</div>
    <div class="auth-fail-title">Access Required</div>
    <div class="auth-fail-msg" id="authFailMsg">Please log in to use VoiceCRM.</div>
    <button class="auth-fail-btn" onclick="goToLogin()">Go to Login</button>
  </div>
</div>

<!-- â•â•â• PAYWALL â€” Blocks when trial expired / no subscription â•â•â• -->
<div id="paywall" class="paywall hidden">
  <div class="pw-logo">VoiceCRM</div>
  <div class="pw-sub">by SheetSouq</div>
  
  <div class="pw-icon">
    <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" fill="rgba(212,162,78,.1)"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><path d="M12 19v4"/><path d="M8 23h8"/></svg>
  </div>
  
  <div id="pwBadge" class="pw-badge expired" style="margin-bottom:16px">Trial Expired</div>
  <div class="pw-title" id="pwTitle">Upgrade to Pro</div>
  <div class="pw-msg" id="pwMsg">Your free trial has ended. Subscribe to continue using VoiceCRM's AI-powered voice features, lead management, and deal tracking.</div>
  
  <!-- Plan Toggle -->
  <div style="display:flex;background:var(--glass);border:1px solid var(--border);border-radius:12px;padding:4px;margin-bottom:20px;width:100%;max-width:340px">
    <button id="pwToggleMonthly" onclick="setPlan('monthly')" style="flex:1;padding:10px;border-radius:10px;border:none;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .2s;background:linear-gradient(135deg,var(--gold),#b8860b);color:#fff">Monthly</button>
    <button id="pwToggleYearly" onclick="setPlan('yearly')" style="flex:1;padding:10px;border-radius:10px;border:none;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .2s;background:transparent;color:var(--text2)">Yearly <span style="color:var(--green);font-size:11px">Save 20%</span></button>
  </div>
  
  <!-- Monthly pricing -->
  <div id="pwMonthly" class="pw-price-box">
    <div class="pw-price-row">
      <span class="pw-price-label">CRM Setup (one-time)</span>
      <span class="pw-price-value">$29</span>
    </div>
    <div class="pw-divider"></div>
    <div class="pw-price-row">
      <span class="pw-price-label">Monthly subscription</span>
      <span class="pw-price-value">$59<span class="pw-price-note">/month</span></span>
    </div>
    <div class="pw-divider"></div>
    <div class="pw-price-row">
      <span class="pw-price-label">14-day free trial</span>
      <span class="pw-price-value" style="color:var(--green);font-size:14px">On the $59/mo</span>
    </div>
    <div class="pw-divider"></div>
    <div class="pw-price-row">
      <span class="pw-price-label">Today you pay</span>
      <span class="pw-price-value" style="font-size:22px">$29</span>
    </div>
  </div>
  
  <!-- Yearly pricing -->
  <div id="pwYearly" class="pw-price-box" style="display:none">
    <div class="pw-price-row">
      <span class="pw-price-label">Yearly subscription</span>
      <span class="pw-price-value">$569<span class="pw-price-note">/year</span></span>
    </div>
    <div class="pw-divider"></div>
    <div class="pw-price-row">
      <span class="pw-price-label">That's only</span>
      <span class="pw-price-value" style="color:var(--teal2)">$47<span class="pw-price-note">/month</span></span>
    </div>
    <div class="pw-divider"></div>
    <div class="pw-price-row">
      <span class="pw-price-label">CRM Setup</span>
      <span class="pw-price-value" style="color:var(--green);font-size:14px">Included free</span>
    </div>
    <div class="pw-divider"></div>
    <div class="pw-price-row">
      <span class="pw-price-label">14-day free trial</span>
      <span class="pw-price-value" style="color:var(--green);font-size:14px">Included</span>
    </div>
    <div class="pw-divider"></div>
    <div class="pw-price-row">
      <span class="pw-price-label">You save</span>
      <span class="pw-price-value" style="color:var(--green)">$168<span class="pw-price-note">/year</span></span>
    </div>
  </div>
  
  <div class="pw-features">
    <div class="pw-feat"><div class="pw-feat-icon"><svg viewBox="0 0 24 24" fill="none" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg></div>AI voice transcription &amp; data extraction</div>
    <div class="pw-feat"><div class="pw-feat-icon"><svg viewBox="0 0 24 24" fill="none" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg></div>Unlimited leads, tasks &amp; deals</div>
    <div class="pw-feat"><div class="pw-feat-icon"><svg viewBox="0 0 24 24" fill="none" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg></div>Real-time dashboard &amp; KPIs</div>
    <div class="pw-feat"><div class="pw-feat-icon"><svg viewBox="0 0 24 24" fill="none" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg></div>Your own private Google Sheet CRM</div>
    <div class="pw-feat"><div class="pw-feat-icon"><svg viewBox="0 0 24 24" fill="none" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg></div>Apple Pay &amp; all major cards accepted</div>
  </div>
  
  <button class="pw-cta" id="pwCta" onclick="startCheckout()">Pay $29 &amp; Start Free Trial</button>
  <div class="pw-cta-sub" id="pwCtaSub">$29 charged now for CRM setup. $59/month starts after 14-day trial.</div>
  <button class="pw-portal hidden" id="pwPortal" onclick="openPortal()">Manage Subscription</button>
  <button class="pw-logout-link" onclick="doLogout()">Log out</button>
</div>

<!-- â•â•â• ONBOARDING WIZARD â•â•â• -->
<div id="wizard" class="wiz hidden">
  <div class="wiz-slides">

    <div class="wiz-slide active" data-s="0">
      <div class="wiz-icon" style="border-color:rgba(212,162,78,.2);box-shadow:0 8px 40px rgba(212,162,78,.12)">
        <svg viewBox="0 0 24 24" stroke="var(--gold)"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" fill="rgba(212,162,78,.15)" stroke="var(--gold)"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
      </div>
      <div class="wiz-title">Welcome to VoiceCRM</div>
      <div class="wiz-desc">Your <strong>voice-powered CRM</strong> companion. Speak naturally and let AI organize your leads, tasks, and deals automatically.</div>
    </div>

    <div class="wiz-slide" data-s="1">
      <div class="wiz-icon" style="border-color:rgba(29,162,180,.2);box-shadow:0 8px 40px rgba(29,162,180,.12)">
        <svg viewBox="0 0 24 24" stroke="var(--teal2)"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="4" rx="1.5"/><rect x="3" y="14" width="7" height="4" rx="1.5"/><rect x="14" y="11" width="7" height="7" rx="1.5"/></svg>
      </div>
      <div class="wiz-tag" style="background:rgba(29,162,180,.1);color:var(--teal2)">Dashboard</div>
      <div class="wiz-title">Your numbers at a glance</div>
      <div class="wiz-desc">See <strong>KPIs, overdue tasks, and today's follow-ups</strong> the moment you open the app. One tap to mark tasks done.</div>
    </div>

    <div class="wiz-slide" data-s="2">
      <div class="wiz-icon" style="border-color:rgba(212,162,78,.2);box-shadow:0 8px 40px rgba(212,162,78,.12)">
        <svg viewBox="0 0 24 24" stroke="var(--gold2)"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" fill="rgba(212,162,78,.1)"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><path d="M8 22h8"/><path d="M12 19v3"/></svg>
      </div>
      <div class="wiz-tag" style="background:rgba(212,162,78,.1);color:var(--gold2)">Voice Input</div>
      <div class="wiz-title">Hold, speak, done</div>
      <div class="wiz-desc"><strong>Hold the gold mic button</strong> and talk naturally. AI transcribes, extracts data, and writes it to your CRM sheet. Review before saving.</div>
    </div>

    <div class="wiz-slide" data-s="3">
      <div class="wiz-icon" style="border-color:rgba(45,212,122,.2);box-shadow:0 8px 40px rgba(45,212,122,.12)">
        <svg viewBox="0 0 24 24" stroke="var(--green2)"><path d="M9 11l3 3 8-8"/><path d="M20 12v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h9"/></svg>
      </div>
      <div class="wiz-tag" style="background:rgba(45,212,122,.1);color:var(--green2)">Tasks & Leads</div>
      <div class="wiz-title">Stay on top of everything</div>
      <div class="wiz-desc"><strong>Tasks</strong> grouped by urgency â€” one tap to complete. <strong>Leads</strong> with tap-to-call. Full editing stays in Google Sheets.</div>
    </div>

    <div class="wiz-slide" data-s="4">
      <div class="wiz-icon" style="border-color:rgba(168,85,247,.2);box-shadow:0 8px 40px rgba(168,85,247,.12)">
        <svg viewBox="0 0 24 24" stroke="var(--purple)"><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/><path d="M12 2L2 7l10 5 10-5L12 2z"/></svg>
      </div>
      <div class="wiz-tag" style="background:rgba(168,85,247,.1);color:var(--purple)">Deals</div>
      <div class="wiz-title">Track your commissions</div>
      <div class="wiz-desc">See your <strong>total, paid, and expected commissions</strong> at a glance. Recent deals with status tracking. Your money, visible.</div>
    </div>

  </div>
  <div class="wiz-footer">
    <button class="wiz-skip" onclick="wizEnd()">Skip</button>
    <div class="wiz-dots" id="wizDots"></div>
    <button class="wiz-next" id="wizBtn" onclick="wizNext()">Next</button>
  </div>
</div>

<!-- â•â•â• SETUP â•â•â• -->
<div id="setupScreen" class="app">
  <div class="screens"><div class="scr on"><div class="su-wrap">
    <div style="font-size:52px;margin-bottom:18px">ğŸ™ï¸</div>
    <h2>Welcome to VoiceCRM</h2>
    <p>Paste your Google Apps Script Web App URL to connect.</p>
    <input type="text" class="su-inp" id="apiUrlInput" placeholder="https://script.google.com/macros/s/xxxxx/exec">
    <button class="su-btn" id="setupBtn" onclick="saveApiUrl()">Connect</button>
    <div class="su-note">Saved locally on this device. One-time setup.</div>
  </div></div></div>
</div>

<!-- â•â•â• MAIN APP â•â•â• -->
<div id="mainApp" class="app hidden">
  <div id="trialBanner" class="trial-banner" onclick="showPaywall()"></div>
  <div class="app-header">
    <div><div class="logo">VoiceCRM</div><div class="logo-sub">by SheetSouq</div></div>
    <div class="hdr-btns"><button class="icon-btn" onclick="refreshCurrent()"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></button><button class="icon-btn" onclick="showSetup()"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button><button class="logout-btn" onclick="doLogout()" title="Logout"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button></div>
  </div>

  <div class="screens">
    <div id="sDash" class="scr on">
      <div class="loading" id="dashLoad"><div class="spinner"></div><div style="font-size:14px;color:var(--text3)">Loading dashboard...</div></div>
      <div id="dashC" class="hidden"></div>
    </div>
    <div id="sVoice" class="scr">
      <div class="vw" id="vWrap">
        <div id="vIdle">
          <div class="st" id="stT">Hold mic to speak</div>
          <div class="ss" id="stS">Press and hold the gold button below</div>
          <div class="wf" id="wfm"></div>
          <div class="tm hidden" id="tmr">0:00</div>
          <div id="fbBox"></div>
          <div class="tb hidden" id="tBox"><div class="tl">Transcription</div><div class="tt" id="tText"></div></div>
          <div class="spinner hidden" id="vSpin"></div>
          <div style="font-size:13px;color:var(--text3);margin-top:20px">or type your update</div>
          <div class="tir"><input type="text" class="ti" id="tInp" placeholder="Type your update here..." onkeydown="if(event.key==='Enter')subText()"><button class="bs" onclick="subText()">Send</button></div>
          <div class="hr">
            <button class="hc" onclick="useH(this)">New lead from Bayut, Mohammed, 2-bed in JLT, budget 1.2 million</button>
            <button class="hc" onclick="useH(this)">Just showed the Marina apartment to Sarah, she loved it</button>
            <button class="hc" onclick="useH(this)">Remind me to call Ahmed on Thursday about the offer</button>
          </div>
        </div>
        <div id="vRes" class="hidden" style="width:100%"></div>
      </div>
    </div>
    <div id="sLeads" class="scr">
      <div class="loading" id="leadsLoad"><div class="spinner"></div><div style="font-size:14px;color:var(--text3)">Loading leads...</div></div>
      <div id="leadsC" class="hidden"></div>
    </div>
    <div id="sTasks" class="scr">
      <div class="loading" id="tasksLoad"><div class="spinner"></div><div style="font-size:14px;color:var(--text3)">Loading tasks...</div></div>
      <div id="tasksC" class="hidden"></div>
    </div>
    <div id="sDeals" class="scr">
      <div class="loading" id="dealsLoad"><div class="spinner"></div><div style="font-size:14px;color:var(--text3)">Loading deals...</div></div>
      <div id="dealsC" class="hidden"></div>
    </div>
  </div>

  <div class="bnav">
    <div class="bnav-i on" data-t="Dash" onclick="sTab('Dash')"><div class="bnav-ic"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="4" rx="1.5"/><rect x="3" y="14" width="7" height="4" rx="1.5"/><rect x="14" y="11" width="7" height="7" rx="1.5"/></svg></div><div class="bnav-lb">Dashboard</div></div>
    <div class="bnav-i" data-t="Leads" onclick="sTab('Leads')"><div class="bnav-ic"><svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M20 21a8 8 0 0 0-16 0"/></svg></div><div class="bnav-lb">Leads</div></div>
    <div class="bnav-i bnav-center" data-t="Voice" ontouchstart="micDown(event)" ontouchend="micUp(event)" onmousedown="micDown(event)" onmouseup="micUp(event)" oncontextmenu="event.preventDefault()"><div class="bnav-mic" id="navMic"><svg viewBox="0 0 24 24" fill="none"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" fill="white"/><path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke="white" stroke-width="2" stroke-linecap="round"/><line x1="12" y1="19" x2="12" y2="23" stroke="white" stroke-width="2" stroke-linecap="round"/><line x1="8" y1="23" x2="16" y2="23" stroke="white" stroke-width="2" stroke-linecap="round"/></svg></div><div class="bnav-lb">Hold to talk</div></div>
    <div class="bnav-i" data-t="Tasks" onclick="sTab('Tasks')"><div class="bnav-ic"><svg viewBox="0 0 24 24"><path d="M9 11l3 3 8-8"/><path d="M20 12v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h9"/></svg></div><div class="bnav-lb">Tasks</div></div>
    <div class="bnav-i" data-t="Deals" onclick="sTab('Deals')"><div class="bnav-ic"><svg viewBox="0 0 24 24"><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/><path d="M12 2L2 7l10 5 10-5L12 2z"/></svg></div><div class="bnav-lb">Deals</div></div>
  </div>
</div>

<div class="mbg" id="eModal" onclick="if(event.target===this)this.classList.remove('show')">
  <div class="mc"><div class="mt2">Edit Data</div><div id="eFlds"></div>
    <div class="ma"><button class="bcf" onclick="saveEd()">Save</button><button class="bsc" onclick="$('eModal').classList.remove('show')">Cancel</button></div>
  </div>
</div>

<script>
var API='',sheetUrl='',aiRes=null,isRec=false,isProcessing=false,mRec=null,aChunks=[],recStart=0,tmInt=null,pStream=null,rMime='';
var curTab='Dash';
var loaded={Dash:false,Leads:false,Tasks:false,Deals:false};
var INT={new_lead:{l:'New Lead',i:'ğŸ‘¤',c:'#1da2b4',t:'Leads'},viewing_update:{l:'Viewing',i:'ğŸ ',c:'#d4a24e',t:'Viewings'},follow_up:{l:'Follow-Up',i:'ğŸ“…',c:'#a855f7',t:'FollowUps'},deal_update:{l:'Deal',i:'ğŸ¤',c:'#2dd47a',t:'Deals'},commission_log:{l:'Commission',i:'ğŸ’°',c:'#d4a24e',t:'Commissions'},property_note:{l:'Property',i:'ğŸ—ï¸',c:'#1da2b4',t:'Properties'},general_note:{l:'Note',i:'ğŸ“',c:'#6b7280',t:'VoiceLog'}};
var PC={'New':'#1da2b4','Contacted':'#25c4d8','Qualified':'#d4a24e','Viewing Scheduled':'#a855f7','Viewing Done':'#7c3aed','Offer Made':'#fbbf24','Negotiating':'#f59e0b','Closed Won':'#2dd47a','Closed Lost':'#ef5350','On Hold':'#6b7280'};

function $(id){return document.getElementById(id);}
function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function fmtAED(n){return n?'AED '+Math.round(n).toLocaleString():'AED 0';}
function api(p){return fetch(API,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(p),redirect:'follow'}).then(function(r){if(!r.ok)throw new Error('Server '+r.status);return r.json();});}

// â•â•â• ONBOARDING WIZARD â•â•â•
var wizSlide=0,wizTotal=5;
function wizInit(){
  var dots=$('wizDots');dots.innerHTML='';
  for(var i=0;i<wizTotal;i++){var d=document.createElement('div');d.className='wiz-dot'+(i===0?' on':'');dots.appendChild(d);}
  wizSlide=0;wizUpdate();
}
function wizNext(){
  if(wizSlide>=wizTotal-1){wizEnd();return;}
  var slides=document.querySelectorAll('.wiz-slide');
  slides[wizSlide].classList.remove('active');slides[wizSlide].classList.add('exit');
  wizSlide++;
  slides[wizSlide].classList.add('active');slides[wizSlide].classList.remove('exit');
  setTimeout(function(){slides[wizSlide-1].classList.remove('exit');},400);
  wizUpdate();
}
function wizUpdate(){
  var dots=$('wizDots').children;
  for(var i=0;i<dots.length;i++)dots[i].classList.toggle('on',i===wizSlide);
  $('wizBtn').textContent=wizSlide>=wizTotal-1?'Get Started':'Next';
}
function wizEnd(){
  localStorage.setItem('voicecrm_wizard','done');
  $('wizard').style.opacity='0';$('wizard').style.transition='opacity .3s ease';
  setTimeout(function(){$('wizard').classList.add('hidden');$('wizard').style.opacity='';chkSetup();},300);
}

function chkSetup(){API=localStorage.getItem('voicecrm_api')||'';if(API){$('setupScreen').classList.add('hidden');$('mainApp').classList.remove('hidden');initApp();}else{$('setupScreen').classList.remove('hidden');$('mainApp').classList.add('hidden');}}
function saveApiUrl(){var u=$('apiUrlInput').value.trim();if(!u||!u.startsWith('https://script.google.com/')){alert('Enter a valid Apps Script URL.');return;}var b=$('setupBtn');b.textContent='Connecting...';b.disabled=true;fetch(u,{method:'POST',body:JSON.stringify({action:'ping'}),redirect:'follow'}).then(function(r){return r.json();}).then(function(d){if(d.success){localStorage.setItem('voicecrm_api',u);API=u;$('setupScreen').classList.add('hidden');$('mainApp').classList.remove('hidden');initApp();}else throw new Error(d.error||'Failed');}).catch(function(e){alert('Error: '+e.message);b.textContent='Connect';b.disabled=false;});}
function showSetup(){$('apiUrlInput').value=API;$('setupScreen').classList.remove('hidden');$('mainApp').classList.add('hidden');$('setupBtn').textContent='Connect';$('setupBtn').disabled=false;}

function initApp(){
  var w=$('wfm');if(!w.children.length)for(var i=0;i<28;i++){var b=document.createElement('div');b.className='wb';b.style.animationDelay=i*.04+'s';w.appendChild(b);}
  if(navigator.mediaDevices)navigator.mediaDevices.getUserMedia({audio:true}).then(function(s){pStream=s;}).catch(function(){});
  loadDash();
}
function sTab(t){
  curTab=t;
  ['Dash','Voice','Leads','Tasks','Deals'].forEach(function(s){$('s'+s).classList.toggle('on',s===t);});
  document.querySelectorAll('.bnav-i').forEach(function(n){n.classList.toggle('on',n.dataset.t===t);});
  if(t==='Leads'&&!loaded.Leads)loadLeads();
  if(t==='Tasks'&&!loaded.Tasks)loadTasks();
  if(t==='Deals'&&!loaded.Deals)loadDeals();
}
function refreshCurrent(){
  loaded={Dash:false,Leads:false,Tasks:false,Deals:false};
  if(curTab==='Dash')loadDash();else if(curTab==='Leads')loadLeads();else if(curTab==='Tasks')loadTasks();else if(curTab==='Deals')loadDeals();
}

// â•â•â• DASHBOARD â•â•â•
function loadDash(){
  $('dashLoad').classList.remove('hidden');$('dashLoad').innerHTML='<div class="spinner"></div><div style="font-size:14px;color:var(--text3)">Loading dashboard...</div>';$('dashC').classList.add('hidden');
  api({action:'getDashboard'}).then(function(d){if(d.success){if(d.sheetUrl)sheetUrl=d.sheetUrl;loaded.Dash=true;renderDash(d);}else $('dashLoad').innerHTML='<div class="empty"><div class="empty-icon">âŒ</div>'+esc(d.error)+'</div>';}).catch(function(e){$('dashLoad').innerHTML='<div class="empty"><div class="empty-icon">ğŸ“¡</div>Connection error<br>Tap ğŸ”„ to retry</div>';});
}
function renderDash(d){
  var k=d.kpis,now=new Date(),days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],mons=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var gr=now.getHours()<12?'Good Morning':now.getHours()<18?'Good Afternoon':'Good Evening';
  var h='';
  h+='<div class="dg">'+gr+(d.agentName?', '+esc(d.agentName):'')+'</div>';
  h+='<div class="dd">'+days[now.getDay()]+', '+now.getDate()+' '+mons[now.getMonth()]+' '+now.getFullYear()+'</div>';
  h+='<div class="kg">';
  h+='<div class="kc bl"><div class="kn">'+k.totalLeads+'</div><div class="kl">Total Leads</div></div>';
  h+='<div class="kc gr"><div class="kn">'+k.activeLeads+'</div><div class="kl">Active</div></div>';
  h+='<div class="kc go"><div class="kn">'+k.dealsWon+'</div><div class="kl">Won</div></div>';
  h+='<div class="kc pu"><div class="kn">'+k.totalViewings+'</div><div class="kl">Viewings</div></div>';
  h+='<div class="kc ye"><div class="kn">'+k.pendingFollowUps+'</div><div class="kl">Pending</div></div>';
  h+='<div class="kc re"><div class="kn">'+k.overdueFollowUps+'</div><div class="kl">Overdue</div></div>';
  h+='</div>';
  var pct=Math.round(d.conversionRate*100);
  h+='<div class="cvb"><div class="cvb-h"><div class="cvb-l">Conversion Rate</div><div class="cvb-p">'+pct+'%</div></div><div class="cvb-t"><div class="cvb-f" style="width:'+Math.min(pct,100)+'%"></div></div><div class="cvb-s">Won '+k.dealsWon+' of '+k.totalLeads+' leads</div></div>';
  if(d.overdueFollowUps&&d.overdueFollowUps.length){h+='<div class="section"><div class="sec-h">ğŸš¨ Overdue ('+d.overdueFollowUps.length+')</div><div class="card">';d.overdueFollowUps.forEach(function(f){h+=taskRow(f,'overdue');});h+='</div></div>';}
  if(d.todayFollowUps&&d.todayFollowUps.length){h+='<div class="section"><div class="sec-h">ğŸ“Œ Today\'s Tasks</div><div class="card">';d.todayFollowUps.forEach(function(f){h+=taskRow(f,'today');});h+='</div></div>';}
  if(sheetUrl){h+='<a href="'+sheetUrl+'" target="_blank" class="open-sheet">ğŸ“„ Open Full CRM in Google Sheets</a>';}
  h+='<div class="footer">VoiceCRM by SheetSouq</div>';
  $('dashC').innerHTML=h;$('dashLoad').classList.add('hidden');$('dashC').classList.remove('hidden');
}
function taskRow(f,type){
  var p=f.priority?f.priority.toLowerCase():'medium';
  var dl=type==='overdue'?f.dueDate:type==='today'?'Today':f.dueDate;
  var bc=type==='overdue'?'badge-red':type==='today'?'badge-gold':'badge-blue';
  var ri=f.rowIndex||0;
  return '<div class="row"><div class="row-bar '+type+'"></div><div class="row-body"><div class="row-title">'+esc(f.client)+'</div><div class="row-sub">'+esc(f.action+(f.details?' â€” '+f.details:''))+'</div></div><div class="row-badge '+bc+'">'+esc(dl)+'</div>'+(ri?'<button class="check-btn" onclick="completeFU('+ri+',this)" title="Mark done">âœ“</button>':'')+'</div>';
}

// â•â•â• TASKS â•â•â•
function loadTasks(){
  $('tasksLoad').classList.remove('hidden');$('tasksLoad').innerHTML='<div class="spinner"></div><div style="font-size:14px;color:var(--text3)">Loading tasks...</div>';$('tasksC').classList.add('hidden');
  api({action:'getFollowUps'}).then(function(d){if(d.success){loaded.Tasks=true;renderTasks(d);}else $('tasksLoad').innerHTML='<div class="empty"><div class="empty-icon">âŒ</div>'+esc(d.error)+'</div>';}).catch(function(){$('tasksLoad').innerHTML='<div class="empty"><div class="empty-icon">ğŸ“¡</div>Connection error<br>Tap ğŸ”„ to retry</div>';});
}
function renderTasks(d){
  var h='',total=d.overdue.length+d.today.length+d.upcoming.length;
  if(total===0&&d.completed.length===0){h='<div class="empty"><div class="empty-icon">âœ¨</div>No tasks yet!<br>Use voice to create follow-ups.</div>';}else{
    if(d.overdue.length){h+='<div class="section"><div class="sec-h">ğŸš¨ Overdue ('+d.overdue.length+')</div><div class="card">';d.overdue.forEach(function(f){h+=taskRow(f,'overdue');});h+='</div></div>';}
    if(d.today.length){h+='<div class="section"><div class="sec-h">ğŸ“Œ Today ('+d.today.length+')</div><div class="card">';d.today.forEach(function(f){h+=taskRow(f,'today');});h+='</div></div>';}
    if(d.upcoming.length){h+='<div class="section"><div class="sec-h">ğŸ“… Next 7 Days ('+d.upcoming.length+')</div><div class="card">';d.upcoming.forEach(function(f){h+=taskRow(f,'upcoming');});h+='</div></div>';}
    if(d.completed.length){h+='<div class="section"><div class="sec-h" style="opacity:.4">âœ… Recently Completed</div><div class="card" style="opacity:.45">';d.completed.forEach(function(f){h+='<div class="row"><div class="row-bar done"></div><div class="row-body"><div class="row-title" style="text-decoration:line-through;opacity:.5">'+esc(f.client)+'</div><div class="row-sub">'+esc(f.action)+'</div></div><div class="row-badge badge-green">Done</div></div>';});h+='</div></div>';}}
  if(sheetUrl){h+='<a href="'+sheetUrl+'" target="_blank" class="open-sheet">ğŸ“„ View all tasks in Google Sheets</a>';}
  h+='<div class="footer">VoiceCRM by SheetSouq</div>';$('tasksC').innerHTML=h;$('tasksLoad').classList.add('hidden');$('tasksC').classList.remove('hidden');
}
function completeFU(rowIndex,btn){
  btn.textContent='â³';btn.disabled=true;btn.style.opacity='.5';
  api({action:'completeFollowUp',rowIndex:rowIndex}).then(function(d){if(d.success){btn.textContent='âœ…';btn.style.background='var(--green)';btn.style.borderColor='var(--green)';btn.style.color='#fff';btn.style.opacity='1';btn.style.boxShadow='0 0 16px var(--green-glow)';var row=btn.closest('.row');if(row)setTimeout(function(){row.style.transition='all .4s ease';row.style.opacity='0';row.style.transform='translateX(40px)';row.style.height='0';row.style.padding='0';row.style.overflow='hidden';setTimeout(function(){row.remove();},400);},600);loaded.Dash=false;loaded.Tasks=false;}else{btn.textContent='âœ“';btn.disabled=false;btn.style.opacity='1';alert('Error: '+(d.error||''));}}).catch(function(e){btn.textContent='âœ“';btn.disabled=false;btn.style.opacity='1';alert('Error: '+e.message);});
}

// â•â•â• LEADS â•â•â•
function loadLeads(){
  $('leadsLoad').classList.remove('hidden');$('leadsLoad').innerHTML='<div class="spinner"></div><div style="font-size:14px;color:var(--text3)">Loading leads...</div>';$('leadsC').classList.add('hidden');
  api({action:'getLeads'}).then(function(d){if(d.success){loaded.Leads=true;renderLeads(d);}else $('leadsLoad').innerHTML='<div class="empty"><div class="empty-icon">âŒ</div>'+esc(d.error)+'</div>';}).catch(function(){$('leadsLoad').innerHTML='<div class="empty"><div class="empty-icon">ğŸ“¡</div>Connection error<br>Tap ğŸ”„ to retry</div>';});
}
function renderLeads(d){
  var h='';
  if(!d.leads||!d.leads.length){h='<div class="empty"><div class="empty-icon">ğŸ‘¤</div>No leads yet!<br>Use voice to add your first lead.</div>';}else{
    h+='<div class="section"><div class="sec-h">ğŸ‘¤ Recent Leads ('+d.leads.length+' of '+d.total+')</div><div class="card">';
    d.leads.forEach(function(l){
      var sc=PC[l.status]||'#6b7280';var bc=l.status==='Closed Won'?'badge-green':l.status==='Closed Lost'?'badge-red':l.status==='New'?'badge-blue':'badge-gold';
      var sub=[];if(l.area)sub.push(l.area);if(l.propType)sub.push(l.propType);if(l.budget)sub.push(l.budget);if(l.source)sub.push(l.source);
      h+='<div class="row"><div class="row-bar" style="background:'+sc+';box-shadow:0 0 8px '+sc+'33"></div><div class="row-body"><div class="row-title">'+esc(l.name||l.id)+'</div><div class="row-sub">'+esc(sub.join(' â€¢ '))+'</div></div><div class="row-badge '+bc+'">'+esc(l.status||'New')+'</div>';
      if(l.phone)h+='<a href="tel:'+esc(l.phone)+'" class="call-btn" title="Call '+esc(l.name)+'">ğŸ“</a>';
      h+='</div>';});h+='</div></div>';}
  if(sheetUrl){h+='<a href="'+sheetUrl+'" target="_blank" class="open-sheet">ğŸ“„ View all leads in Google Sheets</a>';}
  h+='<div class="footer">VoiceCRM by SheetSouq</div>';$('leadsC').innerHTML=h;$('leadsLoad').classList.add('hidden');$('leadsC').classList.remove('hidden');
}

// â•â•â• DEALS â•â•â•
function loadDeals(){
  $('dealsLoad').classList.remove('hidden');$('dealsLoad').innerHTML='<div class="spinner"></div><div style="font-size:14px;color:var(--text3)">Loading deals...</div>';$('dealsC').classList.add('hidden');
  api({action:'getDeals'}).then(function(d){if(d.success){loaded.Deals=true;renderDeals(d);}else $('dealsLoad').innerHTML='<div class="empty"><div class="empty-icon">âŒ</div>'+esc(d.error)+'</div>';}).catch(function(){$('dealsLoad').innerHTML='<div class="empty"><div class="empty-icon">ğŸ“¡</div>Connection error<br>Tap ğŸ”„ to retry</div>';});
}
function renderDeals(d){
  var h='',c=d.commissions;
  h+='<div class="section"><div class="sec-h">ğŸ’° Commission Summary</div><div class="card"><div class="comm-grid">';
  h+='<div class="comm-item"><div class="comm-val" style="color:var(--gold2)">'+fmtAED(c.total)+'</div><div class="comm-lbl">Total</div></div>';
  h+='<div class="comm-item"><div class="comm-val" style="color:var(--green2)">'+fmtAED(c.myNet)+'</div><div class="comm-lbl">My Net</div></div>';
  h+='<div class="comm-item"><div class="comm-val" style="color:var(--green)">'+fmtAED(c.paid)+'</div><div class="comm-lbl">Paid</div></div>';
  h+='<div class="comm-item"><div class="comm-val" style="color:var(--gold)">'+fmtAED(c.expected)+'</div><div class="comm-lbl">Expected</div></div>';
  h+='</div></div></div>';
  if(!d.deals||!d.deals.length){h+='<div class="empty"><div class="empty-icon">ğŸ¤</div>No deals yet!<br>Use voice to log your first deal.</div>';}else{
    h+='<div class="section"><div class="sec-h">ğŸ¤ Recent Deals ('+d.deals.length+' of '+d.totalDeals+')</div><div class="card">';
    d.deals.forEach(function(dl){
      var bc=dl.status==='Completed'||dl.status==='Transfer Done'?'badge-green':dl.status==='Fell Through'?'badge-red':'badge-gold';
      var sub=[];if(dl.property)sub.push(dl.property);if(dl.amount)sub.push(fmtAED(dl.amount));if(dl.type)sub.push(dl.type);
      h+='<div class="row"><div class="row-bar" style="background:var(--gold);box-shadow:0 0 8px var(--gold-glow)"></div><div class="row-body"><div class="row-title">'+esc(dl.client||dl.id)+'</div><div class="row-sub">'+esc(sub.join(' â€¢ '))+'</div></div><div class="row-badge '+bc+'">'+esc(dl.status||'Pending')+'</div></div>';});h+='</div></div>';}
  if(sheetUrl){h+='<a href="'+sheetUrl+'" target="_blank" class="open-sheet">ğŸ“„ Manage deals in Google Sheets</a>';}
  h+='<div class="footer">VoiceCRM by SheetSouq</div>';$('dealsC').innerHTML=h;$('dealsLoad').classList.add('hidden');$('dealsC').classList.remove('hidden');
}

// â•â•â• VOICE â•â•â•
function showFB(m,t){$('fbBox').innerHTML='<div class="fb '+(t||'info')+'">'+m+'</div>';}
function hideFB(){$('fbBox').innerHTML='';}
function stTm(){recStart=Date.now();$('tmr').classList.remove('hidden');tmInt=setInterval(function(){var s=Math.floor((Date.now()-recStart)/1000);$('tmr').textContent=Math.floor(s/60)+':'+(s%60<10?'0':'')+(s%60);},200);}
function spTm(){clearInterval(tmInt);$('tmr').classList.add('hidden');}
function micDown(e){e.preventDefault();if(isRec||isProcessing)return;sTab('Voice');aiRes=null;aChunks=[];isRec=true;$('navMic').classList.add('recording');$('vRes').classList.add('hidden');$('vIdle').style.display='';$('tBox').classList.add('hidden');$('wfm').classList.add('on');$('stT').textContent='ğŸ”´ Recording...';$('stT').style.color='var(--red)';$('stS').textContent='Release to send';showFB('ğŸ™ï¸ <strong>Recording!</strong> Release finger when done.','ok');if(pStream&&pStream.active){beginRec(pStream);return;}navigator.mediaDevices.getUserMedia({audio:true}).then(function(s){pStream=s;beginRec(s);}).catch(function(e2){isRec=false;$('navMic').classList.remove('recording');showFB(e2.name==='NotAllowedError'?'âŒ Mic blocked. Tap ğŸ”’ â†’ Allow.':'âŒ '+e2.message,'err');$('stT').textContent='Mic unavailable';$('stT').style.color='var(--red)';$('stS').textContent='';});}
function micUp(e){e.preventDefault();if(!isRec)return;isRec=false;$('navMic').classList.remove('recording');$('wfm').classList.remove('on');if(mRec&&mRec.state!=='inactive')mRec.stop();else{spTm();vIdle();}}
function beginRec(s){var o={};if(MediaRecorder.isTypeSupported('audio/webm;codecs=opus'))o.mimeType='audio/webm;codecs=opus';else if(MediaRecorder.isTypeSupported('audio/webm'))o.mimeType='audio/webm';else if(MediaRecorder.isTypeSupported('audio/mp4'))o.mimeType='audio/mp4';rMime=o.mimeType||'audio/webm';mRec=new MediaRecorder(s,o);mRec.ondataavailable=function(e){if(e.data&&e.data.size>0)aChunks.push(e.data);};mRec.onstop=function(){spTm();if(!aChunks.length){showFB('No audio.','warn');vIdle();return;}var blob=new Blob(aChunks,{type:rMime}),sec=Math.floor((Date.now()-recStart)/1000);if(sec<1){showFB('Too short â€” hold longer.','warn');vIdle();return;}isProcessing=true;showFB('ğŸµ '+sec+'s recorded. Processing...','ok');$('wfm').classList.add('hidden');$('vSpin').classList.remove('hidden');$('stT').textContent='âš™ï¸ Transcribing...';$('stT').style.color='var(--gold)';$('stS').textContent='Whisper â†’ Claude AI';var r=new FileReader();r.onloadend=function(){sendAud(r.result.split(',')[1]);};r.readAsDataURL(blob);};mRec.onerror=function(){showFB('Rec error','err');isRec=false;$('navMic').classList.remove('recording');spTm();};mRec.start(250);stTm();}
function sendAud(b){api({action:'processAudio',audio:b}).then(function(r){isProcessing=false;if(r.success&&r.aiResult){aiRes=r.aiResult;if(r.transcript){$('tBox').classList.remove('hidden');$('tText').textContent=r.transcript;}vResult();showFB('âœ“ Processed!','ok');}else{showFB('Error: '+(r.error||''),'err');vErr(r.error);}}).catch(function(e){isProcessing=false;showFB('âŒ '+e.message,'err');vErr('Connection failed.');});}
function procTxt(t){isProcessing=true;$('wfm').classList.add('hidden');$('vSpin').classList.remove('hidden');$('stT').textContent='âš™ï¸ AI thinking...';$('stT').style.color='var(--gold)';$('tBox').classList.remove('hidden');$('tText').textContent=t;showFB('Sending...','info');sTab('Voice');api({action:'processText',text:t}).then(function(r){isProcessing=false;if(r.success&&r.aiResult){aiRes=r.aiResult;vResult();showFB('âœ“ Processed!','ok');}else{showFB('Error: '+(r.error||''),'err');vErr(r.error);}}).catch(function(e){isProcessing=false;showFB('âŒ '+e.message,'err');vErr('Connection failed.');});}
function confirmRes(){if(!aiRes)return;var b=document.querySelector('.bcf');b.textContent='â³ Saving...';b.disabled=true;api({action:'confirmWrite',aiResult:aiRes}).then(function(r){if(r.success){vSaved();showFB('âœ“ Saved!','ok');}else{showFB('Error: '+(r.error||''),'err');b.textContent='âœ“ Confirm & Save';b.disabled=false;}}).catch(function(e){showFB('âŒ '+e.message,'err');b.textContent='âœ“ Confirm & Save';b.disabled=false;});}
function vIdle(){$('vIdle').style.display='';$('vRes').classList.add('hidden');$('stT').textContent='Hold mic to speak';$('stT').style.color='';$('stS').textContent='Press and hold the gold button below';$('wfm').classList.remove('hidden');$('wfm').classList.remove('on');$('vSpin').classList.add('hidden');$('tBox').classList.add('hidden');isProcessing=false;}
function vErr(m){$('vIdle').style.display='';$('stT').textContent=m||'Error';$('stT').style.color='var(--red)';$('stS').textContent='Hold mic to retry';$('wfm').classList.remove('hidden');$('vSpin').classList.add('hidden');isProcessing=false;}
function vResult(){$('vIdle').style.display='none';$('vRes').classList.remove('hidden');$('vSpin').classList.add('hidden');rndRes();}
function vSaved(){$('vRes').classList.add('hidden');$('vIdle').style.display='';$('stT').innerHTML='<div style="font-size:52px;margin-bottom:10px">âœ…</div>Saved!';$('stT').style.color='var(--green)';$('stS').textContent='';$('wfm').classList.add('hidden');$('tBox').classList.add('hidden');loaded={Dash:false,Leads:false,Tasks:false,Deals:false};setTimeout(function(){aiRes=null;hideFB();vIdle();sTab('Dash');loadDash();},2000);}
function rndRes(){
  var r=aiRes;if(!r)return;var it=INT[r.intent]||INT.general_note,cf=Math.round((r.confidence||0)*100),cc=cf>=85?'var(--green)':cf>=70?'var(--gold)':'var(--red)',h='';
  h+='<div class="rc" style="border:1px solid '+it.c+'33"><div class="rh" style="background:linear-gradient(135deg,'+it.c+'12,'+it.c+'05)"><div class="ri"><span style="font-size:26px">'+it.i+'</span><div><div class="rl" style="color:'+it.c+'">'+it.l+'</div><div class="rt2">â†’ '+it.t+'</div></div></div><div class="cbg" style="background:'+cc+'18;color:'+cc+'">'+cf+'%</div></div>';
  h+='<div class="rb"><div class="rcl">"'+esc(r.clean_text||'')+'"</div>';
  if(r.data){h+='<div class="dg2">';Object.keys(r.data).forEach(function(k){var v=r.data[k];if(!v&&v!==0)return;var lb=k.replace(/_/g,' ').replace(/\b\w/g,function(c){return c.toUpperCase();}),dv=typeof v==='number'&&v>1000?fmtAED(v):String(v);h+='<div class="df"><div class="dk">'+esc(lb)+'</div><div class="dv">'+esc(dv)+'</div></div>';});h+='</div>';}
  if(r.follow_up_suggestion){h+='<div class="fub"><span style="font-size:18px">ğŸ“…</span><div><div class="ful">Auto Follow-Up</div><div class="fut">'+esc(r.follow_up_suggestion.action)+'<span class="fud"> in '+r.follow_up_suggestion.due_days+'d</span></div></div></div>';}
  h+='</div><div class="act"><button class="bcf" onclick="confirmRes()">âœ“ Confirm & Save</button><button class="bsc" onclick="openEd()">Edit</button><button class="bsc" onclick="hideFB();vIdle()">Retry</button></div></div>';
  $('vRes').innerHTML=h;
}
function openEd(){if(!aiRes||!aiRes.data)return;var h='';Object.keys(aiRes.data).forEach(function(k){var v=aiRes.data[k];if(v===null||v===undefined)v='';h+='<div class="mf"><label class="mlb">'+esc(k.replace(/_/g,' '))+'</label><input class="mi" data-key="'+k+'" value="'+esc(String(v))+'"></div>';});$('eFlds').innerHTML=h;$('eModal').classList.add('show');}
function saveEd(){document.querySelectorAll('#eFlds .mi').forEach(function(i){var k=i.dataset.key,v=i.value;if(!isNaN(v)&&v.trim())v=Number(v);aiRes.data[k]=v;});$('eModal').classList.remove('show');rndRes();}
function subText(){var i=$('tInp'),t=i.value.trim();if(t.length>2){i.value='';procTxt(t);}}
function useH(e){procTxt(e.textContent);}
// â•â•â• AUTH GATE + SUBSCRIPTION GATE â•â•â•
// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘  PASTE YOUR AUTH WEB APP URL BELOW (between the quotes) â•‘
// â•‘  Example: 'https://script.google.com/macros/s/AKf.../exec'  â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var AUTH_API=''; // â† PASTE URL HERE
var SESSION_MAX_AGE=30*24*60*60*1000;
var authData=null;
var subInfo=null; // subscription info from backend

function goToLogin(){
  window.location.href='index.html';
}

function authFail(msg){
  $('authChecking').style.display='none';
  $('authFailMsg').textContent=msg||'Please log in to use VoiceCRM.';
  $('authFailed').classList.add('show');
}

function authPass(subscription){
  $('authWall').classList.add('passed');
  subInfo=subscription||null;
  
  // Check subscription / trial status
  if(subInfo){
    if(subInfo.active){
      // Access granted â€” show trial banner if on trial
      if(subInfo.reason==='trial'||subInfo.reason==='stripe_trial'){
        showTrialBanner(subInfo.trialDaysLeft||14);
      }
      proceedToApp();
    } else {
      // Subscription not active â€” show paywall
      showPaywall(subInfo.reason);
    }
  } else if(!AUTH_API){
    // Development mode â€” skip subscription check
    proceedToApp();
  } else {
    // No subscription info â€” show paywall
    showPaywall('no_subscription');
  }
}

function proceedToApp(){
  $('paywall').classList.add('hidden');
  if(!localStorage.getItem('voicecrm_wizard')){
    $('wizard').classList.remove('hidden');
    wizInit();
  } else {
    chkSetup();
  }
}

function showPaywall(reason){
  // ALWAYS check Stripe for payment before showing paywall
  if(AUTH_API&&authData&&!window._verifyAttempted){
    window._verifyAttempted=true;
    
    // Show loading state
    var pw=$('paywall');
    pw.classList.remove('hidden');
    $('pwTitle').textContent='Checking subscription...';
    $('pwMsg').textContent='Contacting payment server...';
    $('pwCta').style.display='none';
    $('pwBadge').style.display='none';
    
    var verifyUrl=AUTH_API+'?action=verifyPayment&email='+encodeURIComponent(authData.email)+'&token='+encodeURIComponent(authData.token);
    
    fetch(verifyUrl)
    .then(function(r){
      $('pwMsg').textContent='Got response, parsing...';
      return r.json();
    })
    .then(function(d){
      $('pwCta').style.display='';
      $('pwBadge').style.display='';
      
      // DEBUG: show what we got back
      console.log('verifyPayment response:', JSON.stringify(d));
      
      if(d.success&&d.subscription&&d.subscription.active){
        // Payment found! Skip paywall
        subInfo=d.subscription;
        pw.classList.add('hidden');
        if(subInfo.reason==='stripe_trial'){
          showTrialBanner(14);
        }
        proceedToApp();
      } else {
        // DEBUG: show why it failed
        $('pwMsg').textContent='DEBUG: '+JSON.stringify(d).substring(0,200);
        setTimeout(function(){ showPaywallUI(reason); }, 5000);
      }
    })
    .catch(function(err){
      $('pwCta').style.display='';
      $('pwBadge').style.display='';
      // DEBUG: show the error
      $('pwMsg').textContent='DEBUG CATCH: '+err.message;
      setTimeout(function(){ showPaywallUI(reason); }, 5000);
    });
    return;
  }
  
  showPaywallUI(reason);
}

function showPaywallUI(reason){
  var pw=$('paywall');
  var badge=$('pwBadge');
  var title=$('pwTitle');
  var msg=$('pwMsg');
  var cta=$('pwCta');
  var portal=$('pwPortal');
  
  // Customize based on reason
  if(reason==='trial_expired'){
    badge.className='pw-badge expired';
    badge.textContent='Trial Expired';
    title.textContent='Upgrade to Pro';
    msg.textContent='Your 14-day free trial has ended. Subscribe to continue using VoiceCRM\'s AI voice features, lead management, and deal tracking.';
    setPlan(selectedPlan);
    portal.classList.add('hidden');
  } else if(reason==='past_due'){
    badge.className='pw-badge past-due';
    badge.textContent='Payment Failed';
    title.textContent='Update Payment Method';
    msg.textContent='Your last payment didn\'t go through. Please update your payment method to continue using VoiceCRM.';
    cta.textContent='Update Payment';
    cta.onclick=function(){openPortal();};
    portal.classList.remove('hidden');
  } else if(reason==='canceled'||reason==='no_subscription'){
    badge.className='pw-badge expired';
    badge.textContent=reason==='canceled'?'Subscription Ended':'No Subscription';
    title.textContent='Start Your Subscription';
    msg.textContent='Get 14 days free with full access to VoiceCRM. AI voice transcription, lead management, deal tracking â€” all included.';
    setPlan(selectedPlan);
    if(subInfo&&subInfo.setupPaid){
      portal.classList.remove('hidden');
    } else {
      portal.classList.add('hidden');
    }
  }
  
  pw.classList.remove('hidden');
}

function showTrialBanner(daysLeft){
  var banner=$('trialBanner');
  if(!banner)return;
  
  if(daysLeft>7){
    banner.className='trial-banner show ok';
    banner.innerHTML='<span>'+daysLeft+' days left in your free trial</span> â€” <strong>Tap to subscribe</strong>';
  } else if(daysLeft>2){
    banner.className='trial-banner show warn';
    banner.innerHTML='âš ï¸ <span>'+daysLeft+' days left in trial</span> â€” <strong>Subscribe now</strong>';
  } else if(daysLeft>0){
    banner.className='trial-banner show urgent';
    banner.innerHTML='ğŸ”´ <span>Trial ends '+(daysLeft===1?'tomorrow':'in '+daysLeft+' days')+'!</span> â€” <strong>Subscribe to keep access</strong>';
  } else {
    banner.className='trial-banner show urgent';
    banner.innerHTML='ğŸ”´ <span>Trial ending today!</span> â€” <strong>Subscribe now</strong>';
  }
}

// â•â•â• PLAN SELECTION â•â•â•
var selectedPlan='monthly';

function setPlan(plan){
  selectedPlan=plan;
  var mBtn=$('pwToggleMonthly');
  var yBtn=$('pwToggleYearly');
  var mBox=$('pwMonthly');
  var yBox=$('pwYearly');
  var cta=$('pwCta');
  var ctaSub=$('pwCtaSub');
  
  if(plan==='yearly'){
    yBtn.style.background='linear-gradient(135deg,var(--gold),#b8860b)';yBtn.style.color='#fff';
    mBtn.style.background='transparent';mBtn.style.color='var(--text2)';
    mBox.style.display='none';yBox.style.display='';
    cta.innerHTML='Start 14-Day Free Trial';
    ctaSub.textContent='Card required. $569/year charged after 14-day trial. Cancel anytime.';
  } else {
    mBtn.style.background='linear-gradient(135deg,var(--gold),#b8860b)';mBtn.style.color='#fff';
    yBtn.style.background='transparent';yBtn.style.color='var(--text2)';
    yBox.style.display='none';mBox.style.display='';
    cta.innerHTML='Pay $29 &amp; Start Free Trial';
    ctaSub.textContent='$29 charged now for CRM setup. $59/month starts after 14-day trial.';
  }
}

// â•â•â• STRIPE CHECKOUT â•â•â•
function startCheckout(){
  if(!AUTH_API||!authData){alert('Please log in first.');return;}
  
  var cta=$('pwCta');
  cta.textContent='Opening checkout...';
  cta.disabled=true;
  
  var url=AUTH_API+'?action=createCheckout&email='+encodeURIComponent(authData.email)+'&token='+encodeURIComponent(authData.token)+'&plan='+encodeURIComponent(selectedPlan);
  
  fetch(url)
  .then(function(r){return r.json();})
  .then(function(d){
    if(d.success&&d.checkoutUrl){
      window.location.href=d.checkoutUrl;
    } else {
      alert('Error: '+(d.error||'Could not create checkout session.'));
      cta.textContent='Start 14-Day Free Trial';
      cta.disabled=false;
    }
  })
  .catch(function(e){
    alert('Connection error. Please try again.');
    cta.textContent='Start 14-Day Free Trial';
    cta.disabled=false;
  });
}

function openPortal(){
  if(!AUTH_API||!authData)return;
  
  var url=AUTH_API+'?action=customerPortal&email='+encodeURIComponent(authData.email)+'&token='+encodeURIComponent(authData.token);
  
  fetch(url)
  .then(function(r){return r.json();})
  .then(function(d){
    if(d.success&&d.portalUrl){
      window.location.href=d.portalUrl;
    } else {
      alert('Error: '+(d.error||'Could not open billing portal.'));
    }
  })
  .catch(function(){alert('Connection error.');});
}

// â•â•â• AUTH CHECK â•â•â•
function checkAuth(){
  // Step 1: Check localStorage for auth data
  var raw=localStorage.getItem('voicecrm_auth');
  if(!raw){
    goToLogin();
    return;
  }

  // Step 2: Parse auth data
  try{
    authData=JSON.parse(raw);
  }catch(e){
    localStorage.removeItem('voicecrm_auth');
    goToLogin();
    return;
  }

  // Step 3: Validate required fields
  if(!authData.email||!authData.token){
    localStorage.removeItem('voicecrm_auth');
    goToLogin();
    return;
  }

  // Step 4: Check session age
  var age=Date.now()-(authData.ts||0);
  if(age>SESSION_MAX_AGE){
    localStorage.removeItem('voicecrm_auth');
    authFail('Your session has expired. Please log in again.');
    return;
  }

  // Step 5: Normal auth check
  doAuthCheck();
}

function doAuthCheck(){
  var age=Date.now()-(authData.ts||0);
  if(AUTH_API){
    var url=AUTH_API+'?action=checkAuth&email='+encodeURIComponent(authData.email)+'&token='+encodeURIComponent(authData.token);
    fetch(url)
    .then(function(r){return r.json();})
    .then(function(d){
      if(d.success&&d.valid){
        authPass(d.subscription||null);
      } else {
        localStorage.removeItem('voicecrm_auth');
        authFail(d.error||'Session invalid. Please log in again.');
      }
    })
    .catch(function(e){
      if(age<7*24*60*60*1000){
        authPass(null);
      } else {
        authFail('Unable to verify. Please check your connection and try again.');
      }
    });
  } else {
    authPass(null);
  }
}

function doLogout(){
  if(!confirm('Are you sure you want to log out?'))return;
  var email=authData?authData.email:'';
  var token=authData?authData.token:'';

  localStorage.removeItem('voicecrm_auth');
  authData=null;

  if(AUTH_API&&email){
    var url=AUTH_API+'?action=logout&email='+encodeURIComponent(email)+'&token='+encodeURIComponent(token);
    fetch(url).catch(function(){});
  }

  goToLogin();
}

window.onload=function(){
  checkAuth();
};
</script>
</body>
</html>
