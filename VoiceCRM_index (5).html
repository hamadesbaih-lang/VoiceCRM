<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1A1A2E">
  <title>VoiceCRM</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ™ï¸</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Sora:wght@700;800&display=swap" rel="stylesheet">
  <style>
    :root{--navy:#0F3460;--dark:#1A1A2E;--gold:#C8963E;--teal:#16697A;--green:#27AE60;--red:#D63031;--white:#FFF;--safe-top:env(safe-area-inset-top,20px);--safe-bottom:env(safe-area-inset-bottom,0px)}
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    html{height:100%;overflow:hidden;background:#1A1A2E}
    body{height:100%;overflow:hidden;font-family:'DM Sans',-apple-system,sans-serif;background:#1A1A2E;color:var(--white);margin:0}

    /* â”€â”€ Shell â”€â”€ */
    .app{position:fixed;inset:0;display:flex;flex-direction:column;background:linear-gradient(170deg,var(--dark),#0d1b3a 40%,var(--dark))}
    .app-header{flex-shrink:0;padding:8px 20px 6px;padding-top:calc(var(--safe-top) + 8px);display:flex;align-items:center;justify-content:space-between}
    .logo{font-family:'Sora',sans-serif;font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--gold),#e8b44f);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .logo-sub{font-size:9px;color:rgba(255,255,255,.25);letter-spacing:2px;text-transform:uppercase}
    .hdr-btns{display:flex;gap:8px}
    .icon-btn{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:7px 10px;color:rgba(255,255,255,.5);font-size:14px;cursor:pointer;line-height:1}
    .screens{flex:1;overflow:hidden;position:relative}
    .scr{position:absolute;inset:0;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:0 20px 20px;display:none;opacity:0;transition:opacity .2s}
    .scr.on{display:block;opacity:1}

    /* â”€â”€ Bottom Nav â”€â”€ */
    .bnav{flex-shrink:0;display:flex;align-items:flex-end;background:rgba(18,18,42,.95);backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,.06);padding:6px 8px;padding-bottom:calc(var(--safe-bottom) + 6px)}
    .bnav-i{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 0;cursor:pointer;border-radius:10px;transition:.2s}
    .bnav-i.on{background:rgba(200,150,62,.1)}
    .bnav-ic{font-size:20px;line-height:1}
    .bnav-lb{font-size:9px;font-weight:600;color:rgba(255,255,255,.3);letter-spacing:.5px}
    .bnav-i.on .bnav-lb{color:var(--gold)}
    .bnav-center{position:relative;top:-18px;flex:1.2}
    .bnav-center .bnav-lb{margin-top:4px}
    .bnav-center.on{background:none}
    .bnav-mic{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--gold),#b8860b);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(200,150,62,.4);transition:transform .2s,box-shadow .2s}
    .bnav-center.on .bnav-mic{box-shadow:0 4px 24px rgba(200,150,62,.6);transform:scale(1.05)}
    .bnav-mic.recording{background:linear-gradient(135deg,var(--red),#c0392b);box-shadow:0 4px 24px rgba(214,48,49,.5);animation:navPulse 1.5s ease-out infinite;transform:scale(1.1)}
    @keyframes navPulse{0%{box-shadow:0 0 0 0 rgba(214,48,49,.5)}50%{box-shadow:0 0 0 16px rgba(214,48,49,0)}100%{box-shadow:0 0 0 0 rgba(214,48,49,0)}}

    /* â”€â”€ Setup â”€â”€ */
    .su-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100%;padding:40px 0;text-align:center}
    .su-wrap h2{font-family:'Sora',sans-serif;font-size:20px;margin-bottom:8px;color:var(--gold)}
    .su-wrap p{font-size:13px;color:rgba(255,255,255,.4);margin-bottom:24px;line-height:1.6}
    .su-inp{width:100%;max-width:360px;padding:14px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.05);color:#fff;font-size:14px;outline:none;font-family:inherit;margin-bottom:12px}
    .su-inp::placeholder{color:rgba(255,255,255,.25)}
    .su-btn{width:100%;max-width:360px;padding:14px;border-radius:14px;border:none;background:linear-gradient(135deg,var(--gold),#b8860b);color:#fff;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit}
    .su-btn:disabled{opacity:.4}
    .su-note{font-size:11px;color:rgba(255,255,255,.2);margin-top:16px;line-height:1.5}

    /* â”€â”€ Shared components â”€â”€ */
    .loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 0;gap:16px}
    .spinner{width:40px;height:40px;border-radius:50%;border:3px solid rgba(200,150,62,.15);border-top-color:var(--gold);animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .empty{text-align:center;padding:40px 20px;color:rgba(255,255,255,.3);font-size:13px;line-height:1.6}
    .empty-icon{font-size:40px;margin-bottom:12px;opacity:.5}
    .section{margin-bottom:16px}
    .sec-h{font-size:14px;font-weight:700;color:rgba(255,255,255,.8);margin-bottom:10px;display:flex;align-items:center;gap:6px}
    .card{background:rgba(255,255,255,.04);border-radius:14px;border:1px solid rgba(255,255,255,.06);overflow:hidden}
    .open-sheet{display:block;text-align:center;padding:14px;margin:16px 0;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);color:var(--gold);font-size:13px;font-weight:700;text-decoration:none;letter-spacing:.5px}
    .footer{text-align:center;padding:20px 0;font-size:10px;color:rgba(255,255,255,.12)}

    /* â”€â”€ Dashboard â”€â”€ */
    .dg{font-size:18px;font-weight:700;margin:12px 0 4px;color:rgba(255,255,255,.9)}
    .dd{font-size:12px;color:rgba(255,255,255,.3);margin-bottom:16px}
    .kg{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px}
    .kc{background:rgba(255,255,255,.04);border-radius:16px;padding:14px 12px;border:1px solid rgba(255,255,255,.06);text-align:center;position:relative;overflow:hidden}
    .kc::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
    .kc.bl::before{background:var(--teal)}.kc.gr::before{background:var(--green)}.kc.go::before{background:var(--gold)}.kc.pu::before{background:#7B2D8E}.kc.ye::before{background:#F1C40F}.kc.re::before{background:var(--red)}
    .kn{font-size:28px;font-weight:800;font-family:'Sora',sans-serif;line-height:1}
    .kc.bl .kn{color:#5dc8d9}.kc.gr .kn{color:#5ddb8e}.kc.go .kn{color:var(--gold)}.kc.pu .kn{color:#b366cc}.kc.ye .kn{color:#F1C40F}.kc.re .kn{color:#e87878}
    .kl{font-size:10px;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:.5px;margin-top:4px;font-weight:600}
    .cvb{background:rgba(255,255,255,.04);border-radius:14px;padding:12px 16px;margin-bottom:16px;border:1px solid rgba(255,255,255,.06)}
    .cvb-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .cvb-l{font-size:11px;color:rgba(255,255,255,.4);font-weight:600}
    .cvb-p{font-size:18px;font-weight:800;color:var(--green);font-family:'Sora',sans-serif}
    .cvb-t{height:6px;background:rgba(255,255,255,.08);border-radius:6px;overflow:hidden}
    .cvb-f{height:100%;background:linear-gradient(90deg,var(--green),#2ecc71);border-radius:6px;transition:width .8s}
    .cvb-s{font-size:10px;color:rgba(255,255,255,.25);margin-top:6px;text-align:right}

    /* â”€â”€ Task/Lead/Deal rows â”€â”€ */
    .row{display:flex;align-items:center;padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.04);gap:10px}
    .row:last-child{border-bottom:none}
    .row-bar{width:6px;height:28px;border-radius:3px;flex-shrink:0}
    .row-bar.high,.row-bar.overdue{background:var(--red)}.row-bar.medium,.row-bar.today{background:var(--gold)}.row-bar.low,.row-bar.upcoming{background:var(--teal)}.row-bar.done{background:var(--green)}
    .row-body{flex:1;min-width:0}
    .row-title{font-size:13px;font-weight:600;color:rgba(255,255,255,.85);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .row-sub{font-size:11px;color:rgba(255,255,255,.4);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .row-badge{font-size:10px;font-weight:700;padding:3px 8px;border-radius:8px;flex-shrink:0;white-space:nowrap}
    .badge-red{background:rgba(214,48,49,.15);color:#e87878}
    .badge-gold{background:rgba(200,150,62,.15);color:var(--gold)}
    .badge-blue{background:rgba(22,105,122,.12);color:#5dc8d9}
    .badge-green{background:rgba(39,174,96,.15);color:#5ddb8e}
    .badge-purple{background:rgba(123,45,142,.12);color:#b366cc}
    .check-btn{width:32px;height:32px;border-radius:50%;border:2px solid rgba(255,255,255,.15);background:transparent;color:rgba(255,255,255,.3);font-size:14px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:.2s}
    .check-btn:active{background:var(--green);border-color:var(--green);color:#fff;transform:scale(1.1)}
    .call-btn{width:36px;height:36px;border-radius:50%;border:none;background:rgba(39,174,96,.15);color:#5ddb8e;font-size:16px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;text-decoration:none}

    /* â”€â”€ Commissions grid â”€â”€ */
    .comm-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:12px}
    .comm-item{text-align:center}
    .comm-val{font-size:16px;font-weight:800;font-family:'Sora',sans-serif}
    .comm-lbl{font-size:9px;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:.5px;margin-top:2px}

    /* â”€â”€ Voice â”€â”€ */
    .vw{display:flex;flex-direction:column;align-items:center;min-height:100%;justify-content:center;text-align:center;padding-bottom:20px}
    .st{font-size:18px;font-weight:600;color:rgba(255,255,255,.85);margin-bottom:6px}
    .ss{font-size:13px;color:rgba(255,255,255,.35)}
    .fb{margin:12px 0;padding:10px 16px;border-radius:12px;font-size:13px;text-align:center;line-height:1.5;width:100%;max-width:400px}
    .fb.info{background:rgba(22,105,122,.15);border:1px solid rgba(22,105,122,.3);color:#5dc8d9}
    .fb.ok{background:rgba(39,174,96,.15);border:1px solid rgba(39,174,96,.3);color:#5ddb8e}
    .fb.warn{background:rgba(200,150,62,.15);border:1px solid rgba(200,150,62,.3);color:#e8c56e}
    .fb.err{background:rgba(214,48,49,.15);border:1px solid rgba(214,48,49,.3);color:#e87878}
    .wf{display:flex;align-items:center;justify-content:center;gap:3px;height:40px;margin:12px 0}
    .wb{width:3px;border-radius:2px;height:4px;background:linear-gradient(to top,var(--gold),var(--teal));opacity:.15}
    .wf.on .wb{opacity:.8;animation:wv .8s ease-in-out infinite alternate}
    @keyframes wv{from{height:4px}to{height:32px}}
    .tm{font-size:28px;font-weight:700;color:var(--red);margin:12px 0;font-variant-numeric:tabular-nums}
    .tb{background:rgba(255,255,255,.06);border-radius:16px;padding:16px 20px;margin:12px 0;border:1px solid rgba(200,150,62,.15);max-height:120px;overflow:auto;text-align:left;width:100%}
    .tl{font-size:11px;color:var(--gold);font-weight:600;letter-spacing:1.5px;margin-bottom:8px;text-transform:uppercase}
    .tt{font-size:15px;line-height:1.6;color:rgba(255,255,255,.9)}
    .tir{display:flex;gap:8px;width:100%;max-width:400px;margin:12px 0}
    .ti{flex:1;padding:12px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:#fff;font-size:14px;outline:none;font-family:inherit}
    .ti::placeholder{color:rgba(255,255,255,.25)}
    .bs{padding:12px 20px;border-radius:14px;border:none;background:var(--gold);color:#fff;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit}
    .hr{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:16px}
    .hc{padding:8px 14px;border-radius:20px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;font-family:inherit;text-align:left}

    /* â”€â”€ Result card â”€â”€ */
    .rc{background:rgba(255,255,255,.05);border-radius:20px;overflow:hidden;text-align:left;width:100%;max-width:440px;animation:su .4s ease-out}
    .rh{padding:14px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,.06)}
    .ri{display:flex;align-items:center;gap:10px}
    .rl{font-size:14px;font-weight:700;letter-spacing:.5px}
    .rt2{font-size:11px;color:rgba(255,255,255,.4)}
    .cbg{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700}
    .rb{padding:14px 18px}
    .rcl{font-size:13px;color:rgba(255,255,255,.85);line-height:1.6;margin-bottom:14px;font-style:italic}
    .dg2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .df{background:rgba(255,255,255,.04);border-radius:10px;padding:8px 12px;border:1px solid rgba(255,255,255,.06)}
    .dk{font-size:10px;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:1px;margin-bottom:2px}
    .dv{font-size:13px;color:rgba(255,255,255,.9);font-weight:500;word-break:break-word}
    .fub{margin-top:12px;background:rgba(123,45,142,.12);border-radius:12px;padding:10px 14px;border:1px solid rgba(123,45,142,.2);display:flex;align-items:center;gap:10px}
    .ful{font-size:11px;color:rgba(255,255,255,.5);margin-bottom:2px}
    .fut{font-size:13px;color:rgba(255,255,255,.85)}
    .fud{color:var(--gold);font-weight:600;margin-left:6px}
    .act{padding:12px 18px 16px;display:flex;gap:10px}
    .bcf{flex:1;padding:12px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--green),#219a52);color:#fff;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit}
    .bsc{padding:12px 18px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:transparent;color:rgba(255,255,255,.6);font-size:14px;font-weight:600;cursor:pointer;font-family:inherit}

    /* â”€â”€ Modal â”€â”€ */
    .mbg{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);display:none;align-items:flex-end;justify-content:center;z-index:100}
    .mbg.show{display:flex}
    .mc{background:var(--dark);border-radius:24px 24px 0 0;width:100%;max-width:480px;max-height:80vh;overflow:auto;padding:24px;padding-bottom:calc(24px + var(--safe-bottom))}
    .mt2{font-size:16px;font-weight:700;margin-bottom:20px}
    .mf{margin-bottom:12px}
    .mlb{font-size:11px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;display:block}
    .mi{width:100%;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:#fff;font-size:14px;outline:none;font-family:inherit}
    .ma{display:flex;gap:10px;margin-top:20px}

    @keyframes su{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
    ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:4px}
    .hidden{display:none!important}
  </style>
</head>
<body>

<!-- â•â•â• SETUP â•â•â• -->
<div id="setupScreen" class="app">
  <div class="screens"><div class="scr on"><div class="su-wrap">
    <div style="font-size:48px;margin-bottom:16px">ğŸ™ï¸</div>
    <h2>Welcome to VoiceCRM</h2>
    <p>Paste your Google Apps Script Web App URL to connect.</p>
    <input type="text" class="su-inp" id="apiUrlInput" placeholder="https://script.google.com/macros/s/xxxxx/exec">
    <button class="su-btn" id="setupBtn" onclick="saveApiUrl()">Connect</button>
    <div class="su-note">Saved locally on this device. One-time setup.</div>
  </div></div></div>
</div>

<!-- â•â•â• MAIN APP â•â•â• -->
<div id="mainApp" class="app hidden">
  <div class="app-header">
    <div><div class="logo">VoiceCRM</div><div class="logo-sub">by SheetSouq</div></div>
    <div class="hdr-btns"><button class="icon-btn" onclick="refreshCurrent()">ğŸ”„</button><button class="icon-btn" onclick="showSetup()">âš™ï¸</button></div>
  </div>

  <div class="screens">

    <!-- â•â•â• DASHBOARD â•â•â• -->
    <div id="sDash" class="scr on">
      <div class="loading" id="dashLoad"><div class="spinner"></div><div style="font-size:13px;color:rgba(255,255,255,.3)">Loading dashboard...</div></div>
      <div id="dashC" class="hidden"></div>
    </div>

    <!-- â•â•â• VOICE â•â•â• -->
    <div id="sVoice" class="scr">
      <div class="vw" id="vWrap">
        <div id="vIdle">
          <div class="st" id="stT">Hold mic to speak</div>
          <div class="ss" id="stS">Press and hold the gold button below</div>
          <div class="wf" id="wfm"></div>
          <div class="tm hidden" id="tmr">0:00</div>
          <div id="fbBox"></div>
          <div class="tb hidden" id="tBox"><div class="tl">Transcription</div><div class="tt" id="tText"></div></div>
          <div class="spinner hidden" id="vSpin"></div>
          <div style="font-size:11px;color:rgba(255,255,255,.2);margin-top:16px">or type your update</div>
          <div class="tir"><input type="text" class="ti" id="tInp" placeholder="Type your update here..." onkeydown="if(event.key==='Enter')subText()"><button class="bs" onclick="subText()">Send</button></div>
          <div class="hr">
            <button class="hc" onclick="useH(this)">New lead from Bayut, Mohammed, 2-bed in JLT, budget 1.2 million</button>
            <button class="hc" onclick="useH(this)">Just showed the Marina apartment to Sarah, she loved it</button>
            <button class="hc" onclick="useH(this)">Remind me to call Ahmed on Thursday about the offer</button>
          </div>
        </div>
        <div id="vRes" class="hidden" style="width:100%"></div>
      </div>
    </div>

    <!-- â•â•â• LEADS â•â•â• -->
    <div id="sLeads" class="scr">
      <div class="loading" id="leadsLoad"><div class="spinner"></div><div style="font-size:13px;color:rgba(255,255,255,.3)">Loading leads...</div></div>
      <div id="leadsC" class="hidden"></div>
    </div>

    <!-- â•â•â• TASKS â•â•â• -->
    <div id="sTasks" class="scr">
      <div class="loading" id="tasksLoad"><div class="spinner"></div><div style="font-size:13px;color:rgba(255,255,255,.3)">Loading tasks...</div></div>
      <div id="tasksC" class="hidden"></div>
    </div>

    <!-- â•â•â• DEALS â•â•â• -->
    <div id="sDeals" class="scr">
      <div class="loading" id="dealsLoad"><div class="spinner"></div><div style="font-size:13px;color:rgba(255,255,255,.3)">Loading deals...</div></div>
      <div id="dealsC" class="hidden"></div>
    </div>

  </div>

  <!-- â”€â”€ Bottom Nav â”€â”€ -->
  <div class="bnav">
    <div class="bnav-i on" data-t="Dash" onclick="sTab('Dash')"><div class="bnav-ic">ğŸ“Š</div><div class="bnav-lb">Dashboard</div></div>
    <div class="bnav-i" data-t="Leads" onclick="sTab('Leads')"><div class="bnav-ic">ğŸ‘¤</div><div class="bnav-lb">Leads</div></div>
    <div class="bnav-i bnav-center" data-t="Voice" ontouchstart="micDown(event)" ontouchend="micUp(event)" onmousedown="micDown(event)" onmouseup="micUp(event)" oncontextmenu="event.preventDefault()"><div class="bnav-mic" id="navMic"><svg viewBox="0 0 24 24" fill="none" width="28" height="28"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" fill="white"/><path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke="white" stroke-width="2" stroke-linecap="round"/><line x1="12" y1="19" x2="12" y2="23" stroke="white" stroke-width="2" stroke-linecap="round"/><line x1="8" y1="23" x2="16" y2="23" stroke="white" stroke-width="2" stroke-linecap="round"/></svg></div><div class="bnav-lb">Hold to talk</div></div>
    <div class="bnav-i" data-t="Tasks" onclick="sTab('Tasks')"><div class="bnav-ic">ğŸ“…</div><div class="bnav-lb">Tasks</div></div>
    <div class="bnav-i" data-t="Deals" onclick="sTab('Deals')"><div class="bnav-ic">ğŸ¤</div><div class="bnav-lb">Deals</div></div>
  </div>
</div>

<!-- â”€â”€ Edit Modal â”€â”€ -->
<div class="mbg" id="eModal" onclick="if(event.target===this)this.classList.remove('show')">
  <div class="mc"><div class="mt2">Edit Data</div><div id="eFlds"></div>
    <div class="ma"><button class="bcf" onclick="saveEd()">Save</button><button class="bsc" onclick="$('eModal').classList.remove('show')">Cancel</button></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var API='',sheetUrl='',aiRes=null,isRec=false,isProcessing=false,mRec=null,aChunks=[],recStart=0,tmInt=null,pStream=null,rMime='';
var curTab='Dash';
var loaded={Dash:false,Leads:false,Tasks:false,Deals:false};

var INT={new_lead:{l:'New Lead',i:'ğŸ‘¤',c:'#16697A',t:'Leads'},viewing_update:{l:'Viewing',i:'ğŸ ',c:'#C8963E',t:'Viewings'},follow_up:{l:'Follow-Up',i:'ğŸ“…',c:'#7B2D8E',t:'FollowUps'},deal_update:{l:'Deal',i:'ğŸ¤',c:'#27AE60',t:'Deals'},commission_log:{l:'Commission',i:'ğŸ’°',c:'#C8963E',t:'Commissions'},property_note:{l:'Property',i:'ğŸ—ï¸',c:'#0F3460',t:'Properties'},general_note:{l:'Note',i:'ğŸ“',c:'#1A1A2E',t:'VoiceLog'}};
var PC={'New':'#5dc8d9','Contacted':'#4fb3bf','Qualified':'#C8963E','Viewing Scheduled':'#b366cc','Viewing Done':'#7B2D8E','Offer Made':'#F1C40F','Negotiating':'#e67e22','Closed Won':'#27AE60','Closed Lost':'#D63031','On Hold':'#95a5a6'};

function $(id){return document.getElementById(id);}
function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function fmtAED(n){return n?'AED '+Math.round(n).toLocaleString():'AED 0';}
function api(p){return fetch(API,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(p),redirect:'follow'}).then(function(r){if(!r.ok)throw new Error('Server '+r.status);return r.json();});}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function chkSetup(){API=localStorage.getItem('voicecrm_api')||'';if(API){$('setupScreen').classList.add('hidden');$('mainApp').classList.remove('hidden');initApp();}else{$('setupScreen').classList.remove('hidden');$('mainApp').classList.add('hidden');}}
function saveApiUrl(){var u=$('apiUrlInput').value.trim();if(!u||!u.startsWith('https://script.google.com/')){alert('Enter a valid Apps Script URL.');return;}var b=$('setupBtn');b.textContent='Connecting...';b.disabled=true;fetch(u,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'ping'}),redirect:'follow'}).then(function(r){return r.json();}).then(function(d){if(d.success){localStorage.setItem('voicecrm_api',u);API=u;$('setupScreen').classList.add('hidden');$('mainApp').classList.remove('hidden');initApp();}else throw new Error(d.error||'Failed');}).catch(function(e){alert('Error: '+e.message);b.textContent='Connect';b.disabled=false;});}
function showSetup(){$('apiUrlInput').value=API;$('setupScreen').classList.remove('hidden');$('mainApp').classList.add('hidden');$('setupBtn').textContent='Connect';$('setupBtn').disabled=false;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT & NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initApp(){
  var w=$('wfm');if(!w.children.length)for(var i=0;i<24;i++){var b=document.createElement('div');b.className='wb';b.style.animationDelay=i*.04+'s';w.appendChild(b);}
  if(navigator.mediaDevices)navigator.mediaDevices.getUserMedia({audio:true}).then(function(s){pStream=s;}).catch(function(){});
  loadDash();
}

function sTab(t){
  curTab=t;
  ['Dash','Voice','Leads','Tasks','Deals'].forEach(function(s){$('s'+s).classList.toggle('on',s===t);});
  document.querySelectorAll('.bnav-i').forEach(function(n){n.classList.toggle('on',n.dataset.t===t);});
  // Load data on first visit
  if(t==='Leads'&&!loaded.Leads)loadLeads();
  if(t==='Tasks'&&!loaded.Tasks)loadTasks();
  if(t==='Deals'&&!loaded.Deals)loadDeals();
}

function refreshCurrent(){
  loaded={Dash:false,Leads:false,Tasks:false,Deals:false};
  if(curTab==='Dash')loadDash();
  else if(curTab==='Leads')loadLeads();
  else if(curTab==='Tasks')loadTasks();
  else if(curTab==='Deals')loadDeals();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadDash(){
  $('dashLoad').classList.remove('hidden');$('dashLoad').innerHTML='<div class="spinner"></div><div style="font-size:13px;color:rgba(255,255,255,.3)">Loading dashboard...</div>';
  $('dashC').classList.add('hidden');
  api({action:'getDashboard'}).then(function(d){
    if(d.success){if(d.sheetUrl)sheetUrl=d.sheetUrl;loaded.Dash=true;renderDash(d);}
    else $('dashLoad').innerHTML='<div class="empty"><div class="empty-icon">âŒ</div>'+esc(d.error)+'</div>';
  }).catch(function(e){$('dashLoad').innerHTML='<div class="empty"><div class="empty-icon">ğŸ“¡</div>Connection error<br>Tap ğŸ”„ to retry</div>';});
}

function renderDash(d){
  var k=d.kpis,now=new Date(),days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],mons=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var gr=now.getHours()<12?'Good Morning':now.getHours()<18?'Good Afternoon':'Good Evening';
  var h='';

  h+='<div class="dg">'+gr+(d.agentName?', '+esc(d.agentName):'')+'</div>';
  h+='<div class="dd">'+days[now.getDay()]+', '+now.getDate()+' '+mons[now.getMonth()]+' '+now.getFullYear()+'</div>';

  // KPIs
  h+='<div class="kg">';
  h+='<div class="kc bl"><div class="kn">'+k.totalLeads+'</div><div class="kl">Total Leads</div></div>';
  h+='<div class="kc gr"><div class="kn">'+k.activeLeads+'</div><div class="kl">Active</div></div>';
  h+='<div class="kc go"><div class="kn">'+k.dealsWon+'</div><div class="kl">Won</div></div>';
  h+='<div class="kc pu"><div class="kn">'+k.totalViewings+'</div><div class="kl">Viewings</div></div>';
  h+='<div class="kc ye"><div class="kn">'+k.pendingFollowUps+'</div><div class="kl">Pending</div></div>';
  h+='<div class="kc re"><div class="kn">'+k.overdueFollowUps+'</div><div class="kl">Overdue</div></div>';
  h+='</div>';

  // Conversion
  var pct=Math.round(d.conversionRate*100);
  h+='<div class="cvb"><div class="cvb-h"><div class="cvb-l">Conversion Rate</div><div class="cvb-p">'+pct+'%</div></div><div class="cvb-t"><div class="cvb-f" style="width:'+Math.min(pct,100)+'%"></div></div><div class="cvb-s">Won '+k.dealsWon+' of '+k.totalLeads+' leads</div></div>';

  // Overdue
  if(d.overdueFollowUps&&d.overdueFollowUps.length){
    h+='<div class="section"><div class="sec-h">ğŸš¨ Overdue ('+d.overdueFollowUps.length+')</div><div class="card">';
    d.overdueFollowUps.forEach(function(f){h+=taskRow(f,'overdue');});
    h+='</div></div>';
  }

  // Today
  if(d.todayFollowUps&&d.todayFollowUps.length){
    h+='<div class="section"><div class="sec-h">ğŸ“Œ Today\'s Tasks</div><div class="card">';
    d.todayFollowUps.forEach(function(f){h+=taskRow(f,'today');});
    h+='</div></div>';
  }

  // Open Sheet link
  if(sheetUrl){h+='<a href="'+sheetUrl+'" target="_blank" class="open-sheet">ğŸ“„ Open Full CRM in Google Sheets</a>';}

  h+='<div class="footer">VoiceCRM by SheetSouq</div>';
  $('dashC').innerHTML=h;$('dashLoad').classList.add('hidden');$('dashC').classList.remove('hidden');
}

function taskRow(f,type){
  var p=f.priority?f.priority.toLowerCase():'medium';
  var dl=type==='overdue'?f.dueDate:type==='today'?'Today':f.dueDate;
  var bc=type==='overdue'?'badge-red':type==='today'?'badge-gold':'badge-blue';
  var ri=f.rowIndex||0;
  return '<div class="row"><div class="row-bar '+type+'"></div><div class="row-body"><div class="row-title">'+esc(f.client)+'</div><div class="row-sub">'+esc(f.action+(f.details?' â€” '+f.details:''))+'</div></div><div class="row-badge '+bc+'">'+esc(dl)+'</div>'+(ri?'<button class="check-btn" onclick="completeFU('+ri+',this)" title="Mark done">âœ“</button>':'')+'</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TASKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadTasks(){
  $('tasksLoad').classList.remove('hidden');$('tasksLoad').innerHTML='<div class="spinner"></div><div style="font-size:13px;color:rgba(255,255,255,.3)">Loading tasks...</div>';
  $('tasksC').classList.add('hidden');
  api({action:'getFollowUps'}).then(function(d){
    if(d.success){loaded.Tasks=true;renderTasks(d);}
    else $('tasksLoad').innerHTML='<div class="empty"><div class="empty-icon">âŒ</div>'+esc(d.error)+'</div>';
  }).catch(function(){$('tasksLoad').innerHTML='<div class="empty"><div class="empty-icon">ğŸ“¡</div>Connection error<br>Tap ğŸ”„ to retry</div>';});
}

function renderTasks(d){
  var h='';
  var total=d.overdue.length+d.today.length+d.upcoming.length;

  if(total===0&&d.completed.length===0){
    h='<div class="empty"><div class="empty-icon">âœ¨</div>No tasks yet!<br>Use voice to create follow-ups.</div>';
  } else {
    if(d.overdue.length){
      h+='<div class="section"><div class="sec-h">ğŸš¨ Overdue ('+d.overdue.length+')</div><div class="card">';
      d.overdue.forEach(function(f){h+=taskRow(f,'overdue');});
      h+='</div></div>';
    }
    if(d.today.length){
      h+='<div class="section"><div class="sec-h">ğŸ“Œ Today ('+d.today.length+')</div><div class="card">';
      d.today.forEach(function(f){h+=taskRow(f,'today');});
      h+='</div></div>';
    }
    if(d.upcoming.length){
      h+='<div class="section"><div class="sec-h">ğŸ“… Next 7 Days ('+d.upcoming.length+')</div><div class="card">';
      d.upcoming.forEach(function(f){h+=taskRow(f,'upcoming');});
      h+='</div></div>';
    }
    if(d.completed.length){
      h+='<div class="section"><div class="sec-h" style="opacity:.4">âœ… Recently Completed</div><div class="card" style="opacity:.5">';
      d.completed.forEach(function(f){
        h+='<div class="row"><div class="row-bar done"></div><div class="row-body"><div class="row-title" style="text-decoration:line-through;opacity:.6">'+esc(f.client)+'</div><div class="row-sub">'+esc(f.action)+'</div></div><div class="row-badge badge-green">Done</div></div>';
      });
      h+='</div></div>';
    }
  }

  if(sheetUrl){h+='<a href="'+sheetUrl+'" target="_blank" class="open-sheet">ğŸ“„ View all tasks in Google Sheets</a>';}
  h+='<div class="footer">VoiceCRM by SheetSouq</div>';
  $('tasksC').innerHTML=h;$('tasksLoad').classList.add('hidden');$('tasksC').classList.remove('hidden');
}

function completeFU(rowIndex,btn){
  btn.textContent='â³';btn.disabled=true;btn.style.opacity='.5';
  api({action:'completeFollowUp',rowIndex:rowIndex}).then(function(d){
    if(d.success){
      btn.textContent='âœ…';btn.style.background='var(--green)';btn.style.borderColor='var(--green)';btn.style.color='#fff';btn.style.opacity='1';
      var row=btn.closest('.row');if(row){setTimeout(function(){row.style.transition='all .3s';row.style.opacity='0';row.style.height='0';row.style.padding='0';row.style.overflow='hidden';setTimeout(function(){row.remove();},300);},800);}
      // Refresh data in background
      loaded.Dash=false;loaded.Tasks=false;
    } else {btn.textContent='âœ“';btn.disabled=false;btn.style.opacity='1';alert('Error: '+(d.error||''));}
  }).catch(function(e){btn.textContent='âœ“';btn.disabled=false;btn.style.opacity='1';alert('Error: '+e.message);});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEADS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadLeads(){
  $('leadsLoad').classList.remove('hidden');$('leadsLoad').innerHTML='<div class="spinner"></div><div style="font-size:13px;color:rgba(255,255,255,.3)">Loading leads...</div>';
  $('leadsC').classList.add('hidden');
  api({action:'getLeads'}).then(function(d){
    if(d.success){loaded.Leads=true;renderLeads(d);}
    else $('leadsLoad').innerHTML='<div class="empty"><div class="empty-icon">âŒ</div>'+esc(d.error)+'</div>';
  }).catch(function(){$('leadsLoad').innerHTML='<div class="empty"><div class="empty-icon">ğŸ“¡</div>Connection error<br>Tap ğŸ”„ to retry</div>';});
}

function renderLeads(d){
  var h='';
  if(!d.leads||!d.leads.length){
    h='<div class="empty"><div class="empty-icon">ğŸ‘¤</div>No leads yet!<br>Use voice to add your first lead.</div>';
  } else {
    h+='<div class="section"><div class="sec-h">ğŸ‘¤ Recent Leads ('+d.leads.length+' of '+d.total+')</div><div class="card">';
    d.leads.forEach(function(l){
      var sc=PC[l.status]||'#999';
      var bc=l.status==='Closed Won'?'badge-green':l.status==='Closed Lost'?'badge-red':l.status==='New'?'badge-blue':'badge-gold';
      var sub=[];
      if(l.area)sub.push(l.area);
      if(l.propType)sub.push(l.propType);
      if(l.budget)sub.push(l.budget);
      if(l.source)sub.push(l.source);

      h+='<div class="row">';
      h+='<div class="row-bar" style="background:'+sc+'"></div>';
      h+='<div class="row-body"><div class="row-title">'+esc(l.name||l.id)+'</div><div class="row-sub">'+esc(sub.join(' â€¢ '))+'</div></div>';
      h+='<div class="row-badge '+bc+'">'+esc(l.status||'New')+'</div>';
      if(l.phone){h+='<a href="tel:'+esc(l.phone)+'" class="call-btn" title="Call '+esc(l.name)+'">ğŸ“</a>';}
      h+='</div>';
    });
    h+='</div></div>';
  }

  if(sheetUrl){h+='<a href="'+sheetUrl+'" target="_blank" class="open-sheet">ğŸ“„ View all leads in Google Sheets</a>';}
  h+='<div class="footer">VoiceCRM by SheetSouq</div>';
  $('leadsC').innerHTML=h;$('leadsLoad').classList.add('hidden');$('leadsC').classList.remove('hidden');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadDeals(){
  $('dealsLoad').classList.remove('hidden');$('dealsLoad').innerHTML='<div class="spinner"></div><div style="font-size:13px;color:rgba(255,255,255,.3)">Loading deals...</div>';
  $('dealsC').classList.add('hidden');
  api({action:'getDeals'}).then(function(d){
    if(d.success){loaded.Deals=true;renderDeals(d);}
    else $('dealsLoad').innerHTML='<div class="empty"><div class="empty-icon">âŒ</div>'+esc(d.error)+'</div>';
  }).catch(function(){$('dealsLoad').innerHTML='<div class="empty"><div class="empty-icon">ğŸ“¡</div>Connection error<br>Tap ğŸ”„ to retry</div>';});
}

function renderDeals(d){
  var h='',c=d.commissions;

  // Commission summary
  h+='<div class="section"><div class="sec-h">ğŸ’° Commission Summary</div><div class="card"><div class="comm-grid">';
  h+='<div class="comm-item"><div class="comm-val" style="color:var(--gold)">'+fmtAED(c.total)+'</div><div class="comm-lbl">Total</div></div>';
  h+='<div class="comm-item"><div class="comm-val" style="color:var(--green)">'+fmtAED(c.myNet)+'</div><div class="comm-lbl">My Net</div></div>';
  h+='<div class="comm-item"><div class="comm-val" style="color:#5ddb8e">'+fmtAED(c.paid)+'</div><div class="comm-lbl">Paid</div></div>';
  h+='<div class="comm-item"><div class="comm-val" style="color:#e8c56e">'+fmtAED(c.expected)+'</div><div class="comm-lbl">Expected</div></div>';
  h+='</div></div></div>';

  // Deals list
  if(!d.deals||!d.deals.length){
    h+='<div class="empty"><div class="empty-icon">ğŸ¤</div>No deals yet!<br>Use voice to log your first deal.</div>';
  } else {
    h+='<div class="section"><div class="sec-h">ğŸ¤ Recent Deals ('+d.deals.length+' of '+d.totalDeals+')</div><div class="card">';
    d.deals.forEach(function(dl){
      var bc=dl.status==='Completed'||dl.status==='Transfer Done'?'badge-green':dl.status==='Fell Through'?'badge-red':'badge-gold';
      var sub=[];
      if(dl.property)sub.push(dl.property);
      if(dl.amount)sub.push(fmtAED(dl.amount));
      if(dl.type)sub.push(dl.type);

      h+='<div class="row">';
      h+='<div class="row-bar" style="background:'+(PC[dl.status]||'var(--gold)')+'"></div>';
      h+='<div class="row-body"><div class="row-title">'+esc(dl.client||dl.id)+'</div><div class="row-sub">'+esc(sub.join(' â€¢ '))+'</div></div>';
      h+='<div class="row-badge '+bc+'">'+esc(dl.status||'Pending')+'</div>';
      h+='</div>';
    });
    h+='</div></div>';
  }

  if(sheetUrl){h+='<a href="'+sheetUrl+'" target="_blank" class="open-sheet">ğŸ“„ Manage deals in Google Sheets</a>';}
  h+='<div class="footer">VoiceCRM by SheetSouq</div>';
  $('dealsC').innerHTML=h;$('dealsLoad').classList.add('hidden');$('dealsC').classList.remove('hidden');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOICE â€” HOLD TO RECORD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showFB(m,t){$('fbBox').innerHTML='<div class="fb '+(t||'info')+'">'+m+'</div>';}
function hideFB(){$('fbBox').innerHTML='';}
function stTm(){recStart=Date.now();$('tmr').classList.remove('hidden');tmInt=setInterval(function(){var s=Math.floor((Date.now()-recStart)/1000);$('tmr').textContent=Math.floor(s/60)+':'+(s%60<10?'0':'')+(s%60);},200);}
function spTm(){clearInterval(tmInt);$('tmr').classList.add('hidden');}

function micDown(e){
  e.preventDefault();if(isRec||isProcessing)return;
  sTab('Voice');aiRes=null;aChunks=[];isRec=true;
  $('navMic').classList.add('recording');$('vRes').classList.add('hidden');$('vIdle').style.display='';$('tBox').classList.add('hidden');$('wfm').classList.add('on');
  $('stT').textContent='ğŸ”´ Recording...';$('stT').style.color='var(--red)';$('stS').textContent='Release to send';
  showFB('ğŸ™ï¸ <strong>Recording!</strong> Release finger when done.','ok');
  if(pStream&&pStream.active){beginRec(pStream);return;}
  navigator.mediaDevices.getUserMedia({audio:true}).then(function(s){pStream=s;beginRec(s);}).catch(function(e2){isRec=false;$('navMic').classList.remove('recording');showFB(e2.name==='NotAllowedError'?'âŒ Mic blocked. Tap ğŸ”’ â†’ Allow.':'âŒ '+e2.message,'err');$('stT').textContent='Mic unavailable';$('stT').style.color='var(--red)';$('stS').textContent='';});
}
function micUp(e){e.preventDefault();if(!isRec)return;isRec=false;$('navMic').classList.remove('recording');$('wfm').classList.remove('on');if(mRec&&mRec.state!=='inactive')mRec.stop();else{spTm();vIdle();}}

function beginRec(s){
  var o={};if(MediaRecorder.isTypeSupported('audio/webm;codecs=opus'))o.mimeType='audio/webm;codecs=opus';else if(MediaRecorder.isTypeSupported('audio/webm'))o.mimeType='audio/webm';else if(MediaRecorder.isTypeSupported('audio/mp4'))o.mimeType='audio/mp4';rMime=o.mimeType||'audio/webm';
  mRec=new MediaRecorder(s,o);mRec.ondataavailable=function(e){if(e.data&&e.data.size>0)aChunks.push(e.data);};
  mRec.onstop=function(){spTm();if(!aChunks.length){showFB('No audio.','warn');vIdle();return;}var blob=new Blob(aChunks,{type:rMime}),sec=Math.floor((Date.now()-recStart)/1000);if(sec<1){showFB('Too short â€” hold longer.','warn');vIdle();return;}isProcessing=true;showFB('ğŸµ '+sec+'s recorded. Processing...','ok');$('wfm').classList.add('hidden');$('vSpin').classList.remove('hidden');$('stT').textContent='âš™ï¸ Transcribing...';$('stT').style.color='var(--gold)';$('stS').textContent='Whisper â†’ Claude AI';var r=new FileReader();r.onloadend=function(){sendAud(r.result.split(',')[1]);};r.readAsDataURL(blob);};
  mRec.onerror=function(){showFB('Rec error','err');isRec=false;$('navMic').classList.remove('recording');spTm();};
  mRec.start(250);stTm();
}

function sendAud(b){api({action:'processAudio',audio:b}).then(function(r){isProcessing=false;if(r.success&&r.aiResult){aiRes=r.aiResult;if(r.transcript){$('tBox').classList.remove('hidden');$('tText').textContent=r.transcript;}vResult();showFB('âœ“ Processed!','ok');}else{showFB('Error: '+(r.error||''),'err');vErr(r.error);}}).catch(function(e){isProcessing=false;showFB('âŒ '+e.message,'err');vErr('Connection failed.');});}

function procTxt(t){isProcessing=true;$('wfm').classList.add('hidden');$('vSpin').classList.remove('hidden');$('stT').textContent='âš™ï¸ AI thinking...';$('stT').style.color='var(--gold)';$('tBox').classList.remove('hidden');$('tText').textContent=t;showFB('Sending...','info');sTab('Voice');api({action:'processText',text:t}).then(function(r){isProcessing=false;if(r.success&&r.aiResult){aiRes=r.aiResult;vResult();showFB('âœ“ Processed!','ok');}else{showFB('Error: '+(r.error||''),'err');vErr(r.error);}}).catch(function(e){isProcessing=false;showFB('âŒ '+e.message,'err');vErr('Connection failed.');});}

function confirmRes(){if(!aiRes)return;var b=document.querySelector('.bcf');b.textContent='â³ Saving...';b.disabled=true;api({action:'confirmWrite',aiResult:aiRes}).then(function(r){if(r.success){vSaved();showFB('âœ“ Saved!','ok');}else{showFB('Error: '+(r.error||''),'err');b.textContent='âœ“ Confirm & Save';b.disabled=false;}}).catch(function(e){showFB('âŒ '+e.message,'err');b.textContent='âœ“ Confirm & Save';b.disabled=false;});}

function vIdle(){$('vIdle').style.display='';$('vRes').classList.add('hidden');$('stT').textContent='Hold mic to speak';$('stT').style.color='';$('stS').textContent='Press and hold the gold button below';$('wfm').classList.remove('hidden');$('wfm').classList.remove('on');$('vSpin').classList.add('hidden');$('tBox').classList.add('hidden');isProcessing=false;}
function vErr(m){$('vIdle').style.display='';$('stT').textContent=m||'Error';$('stT').style.color='var(--red)';$('stS').textContent='Hold mic to retry';$('wfm').classList.remove('hidden');$('vSpin').classList.add('hidden');isProcessing=false;}
function vResult(){$('vIdle').style.display='none';$('vRes').classList.remove('hidden');$('vSpin').classList.add('hidden');rndRes();}
function vSaved(){$('vRes').classList.add('hidden');$('vIdle').style.display='';$('stT').innerHTML='<div style="font-size:48px;margin-bottom:8px">âœ…</div>Saved!';$('stT').style.color='var(--green)';$('stS').textContent='';$('wfm').classList.add('hidden');$('tBox').classList.add('hidden');loaded={Dash:false,Leads:false,Tasks:false,Deals:false};setTimeout(function(){aiRes=null;hideFB();vIdle();sTab('Dash');loadDash();},2000);}

function rndRes(){
  var r=aiRes;if(!r)return;var it=INT[r.intent]||INT.general_note,cf=Math.round((r.confidence||0)*100),cc=cf>=85?'var(--green)':cf>=70?'var(--gold)':'var(--red)',h='';
  h+='<div class="rc" style="border:1px solid '+it.c+'33"><div class="rh" style="background:linear-gradient(135deg,'+it.c+'15,'+it.c+'05)"><div class="ri"><span style="font-size:24px">'+it.i+'</span><div><div class="rl" style="color:'+it.c+'">'+it.l+'</div><div class="rt2">â†’ '+it.t+'</div></div></div><div class="cbg" style="background:'+cc+'22;color:'+cc+'">'+cf+'%</div></div>';
  h+='<div class="rb"><div class="rcl">"'+esc(r.clean_text||'')+'"</div>';
  if(r.data){h+='<div class="dg2">';Object.keys(r.data).forEach(function(k){var v=r.data[k];if(!v&&v!==0)return;var lb=k.replace(/_/g,' ').replace(/\b\w/g,function(c){return c.toUpperCase();}),dv=typeof v==='number'&&v>1000?fmtAED(v):String(v);h+='<div class="df"><div class="dk">'+esc(lb)+'</div><div class="dv">'+esc(dv)+'</div></div>';});h+='</div>';}
  if(r.follow_up_suggestion){h+='<div class="fub"><span style="font-size:16px">ğŸ“…</span><div><div class="ful">Auto Follow-Up</div><div class="fut">'+esc(r.follow_up_suggestion.action)+'<span class="fud"> in '+r.follow_up_suggestion.due_days+'d</span></div></div></div>';}
  h+='</div><div class="act"><button class="bcf" onclick="confirmRes()">âœ“ Confirm & Save</button><button class="bsc" onclick="openEd()">Edit</button><button class="bsc" onclick="hideFB();vIdle()">Retry</button></div></div>';
  $('vRes').innerHTML=h;
}

function openEd(){if(!aiRes||!aiRes.data)return;var h='';Object.keys(aiRes.data).forEach(function(k){var v=aiRes.data[k];if(v===null||v===undefined)v='';h+='<div class="mf"><label class="mlb">'+esc(k.replace(/_/g,' '))+'</label><input class="mi" data-key="'+k+'" value="'+esc(String(v))+'"></div>';});$('eFlds').innerHTML=h;$('eModal').classList.add('show');}
function saveEd(){document.querySelectorAll('#eFlds .mi').forEach(function(i){var k=i.dataset.key,v=i.value;if(!isNaN(v)&&v.trim())v=Number(v);aiRes.data[k]=v;});$('eModal').classList.remove('show');rndRes();}
function subText(){var i=$('tInp'),t=i.value.trim();if(t.length>2){i.value='';procTxt(t);}}
function useH(e){procTxt(e.textContent);}

window.onload=function(){chkSetup();};
</script>
</body>
</html>
